/**
 * Spots - 2014-01-28
 * http://spotsmagic.com
 *
 * Copyright (c) 2014 ironSource
 * Licensed Commercial <http://spotsmagic.com/terms>
 */
var configAPI=function(){function a(a){a=_.verifyCallback(a),j=new IDBStore({dbVersion:"3",storeName:"CONFIG",keyPath:"id",onStoreReady:function(){configOverrides.init().then(function(){j.getAll(function(b){_.each(b,function(a){config[a.id]=a.value}),config.uuid||(configAPI.set("uuid",getUUID()),configAPI.set("firstRun",!0),configAPI.set("baseVersion",config.version)),configAPI.setDefault("guid",null),configAPI.setDefault("user",null),a()})})}})}function b(a){return config[a]}function c(a,b){config[a]=b,j.put({id:a,value:b}),k()}function d(a,b){a in config||(config[a]=b,k())}function e(a){_.each(a,function(a,b){c(b,a)})}function f(a){_.each(a,function(a,b){d(b,a)})}function g(){return config}function h(a){delete config[a],j.remove(a),k()}function i(){j.clear()}var j,k=_.debounce(function(){eventManager.dispatchEvent("CONFIG","CONFIG_SET",config)},100);return{init:a,get:b,set:c,remove:h,restoreDefaults:i,setDefault:d,setMultiple:e,setMultipleDefault:f,getConfig:g}}(),config={};configAPI.setDefault("version",chrome.runtime.getManifest().version),configAPI.setDefault("spots_android_app_id","com.friedcookie.spots"),configAPI.setDefault("analytics_account","UA-50474899-1"),configAPI.setDefault("backgroundInitialized",$.Deferred()),configAPI.setDefault("debugEnabled",!0),configAPI.setDefault("cb","?cb=0.2.4"),configAPI.setDefault("spots_list",["debug","favorites","phone","search","gallery","facebook","weather","apps","discovery","review"]),configAPI.setDefault("module_import_list",["analytics","idb","tabs","spotsAPI","spotsManager","pushService","eventManager","user","googlePlayUtils","_gaq","ftueAPI","graphicAssets","urls","notificationManager","utilsAPI","configAPI","userVoice","weather","discovery","languageManager","S3","webScrapper","modalManager"]),configAPI.setDefault("enable_encryption",!0),configAPI.setDefault("token_valid_time",6048e5),configAPI.setDefault("token_renew_attempts",10),configAPI.setDefault("jGmhAKOXuv","3E79D1AF7DB595d7"),configAPI.setDefault("jaJpMNvagm","o6kitqcp710opjwh"),configAPI.setDefault("UNYHmQpRgm","6xpslt05kh8ofm7h"),configAPI.setDefault("idp",""),configAPI.setDefault("hasAndroidDevices",!1),configAPI.setDefault("didLogin",!1),configAPI.setDefault("InstalledAndroidApp",!1),configAPI.setDefault("cleanupEventListenersInterval",3e5),configAPI.setDefault("reloadCounter",0),configAPI.setDefault("maxReloads",2),configAPI.setDefault("userIsOrganic",!0),configAPI.setDefault("remoteScriptsInterval",36e5),configAPI.setDefault("defaultEventsSampleRate",.01),configAPI.setDefault("settingTabs",["general","presets","background","colors","favorites","notifications","android","power_search","discovery"]),configAPI.setDefault("idb_version",19),configAPI.setDefault("idb_tables",["SPOTS_DATA","SERVER_QUEUE","MAGIC_DATA","COLOR_PICKER_CACHE","NOTIFICATIONS","SCREENSHOTS","SCRAPPER_META_CACHE"]),configAPI.setDefault("opentab_enabled",!0),configAPI.setDefault("opentab_toggle_key_code",27),configAPI.setDefault("opentab_toggle_key_timeout",500),configAPI.setDefault("opentab_sensitivity_L",.2),configAPI.setDefault("opentab_sensitivity_R",.2),configAPI.setDefault("opentabNumAppsDisplayed",5),configAPI.setDefault("appsDisplayed",!0),configAPI.setDefault("opentabDefaultResultsLimit",5),configAPI.setDefault("opentabCSS",{before:["/app/opentab/css/opentab.css","/app/css/components.css","/app/opentab/css/ftue.css","/app/opentab/css/opentabNotifications.css"],after:[]}),configAPI.setDefault("showPhone",!0),configAPI.setDefault("domain","spotsmagic.com"),configAPI.setDefault("url_www","http://"+config.domain),configAPI.setDefault("baseUpdatePageUrl","http://"+config.domain+"/updates/chrome/"),configAPI.setDefault("url_api","https://api."+config.domain),configAPI.setDefault("url_ts",config.url_api+"/ts"),configAPI.setDefault("url_feedback",config.url_www+"/feedback?"),configAPI.setDefault("facebookLikeSrc","http://spotsmagic.com/fblike"),configAPI.setDefault("url_pushServer","http://push."+config.domain+"/subscribe?events="),configAPI.setDefault("url_auth_complete","https?:\\/\\/(www\\.)?api\\."+config.domain+"\\/(auth_complete|anon_complete)\\?"),configAPI.setDefault("static_redirects_json","https://s3.amazonaws.com/static.addon.speedial.com/spt/config/redirects.json"),configAPI.setDefault("redirects_autopull_interval",864e5),configAPI.setDefault("url_hoolapp","http://api.hoolapp.com/query.php"),configAPI.setDefault("url_products_search","http://prd."+config.domain+"/search/"),configAPI.setDefault("color_picker_api","http://picker."+config.domain+"/"),configAPI.setDefault("privacyPolicyLink","http://"+config.domain+"/privacy-policy"),configAPI.setDefault("termsOfUseLink","http://"+config.domain+"/terms-of-use"),configAPI.setDefault("geolocationServiceUrl","http://ip-api.com/json"),configAPI.setDefault("weatherAPI","http://api.openweathermap.org/data/2.5/weather"),configAPI.setDefault("searchProviderUrl","https://www.google.com/?#q="),configAPI.setDefault("userVoiceData",{sid:null,forum:null}),configAPI.setDefault("api_autoPostTimer",6e3),configAPI.setDefault("themes",[{thumb:"/img/themes/strips/thumb.png",settings:{bodyClass:"default",themeId:"strips",bgColor:"#03DDDD",themeColor:"#C23AFF",accentColor:"#5900A0",bgImage:"/img/themes/strips/bg.png",bgFooter:"/img/themes/strips/footer.png",bgFooterHeight:300,favoritesOpacity:.8,favoritesMargin:10,favoritesBorder:0}},{thumb:"/img/themes/fishing/thumb.png",settings:{bodyClass:"default",themeId:"fishing",bgColor:"#FEE7CA",themeColor:"#C046FF",accentColor:"#00B6B7",bgImage:"/img/themes/fishing/bg.png",bgFooter:"/img/themes/fishing/footer.png",bgFooterHeight:457,favoritesOpacity:.8,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/space/thumb.png",settings:{bodyClass:"default",themeId:"space",bgColor:"#88A5ED",themeColor:"#978F8A",accentColor:"#3B7CFF",bgImage:"/img/themes/space/bg.png",bgFooter:"/img/themes/space/footer.png",bgFooterHeight:365,favoritesOpacity:1,favoritesMargin:11,favoritesBorder:4}},{thumb:"/img/themes/forest/thumb.png",settings:{bodyClass:"default",themeId:"forest",bgColor:"#BAD0FF",themeColor:"#3678FF",accentColor:"#014E9D",bgImage:"/img/themes/forest/bg.png",bgFooter:"/img/themes/forest/footer.png",bgFooterHeight:282,favoritesOpacity:.9,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/bubbles/thumb.png",settings:{bodyClass:"default",themeId:"bubbles",bgColor:"#CBF0F1",themeColor:"#00B6B8",accentColor:"#0080D7",bgImage:"/img/themes/bubbles/bg.png",bgFooter:"/img/themes/bubbles/footer.png",bgFooterHeight:341,favoritesOpacity:.5,favoritesMargin:10,favoritesBorder:0}},{thumb:"/img/themes/sunset/thumb.png",settings:{bodyClass:"default",themeId:"sunset",bgColor:"#A5D3F0",themeColor:"#0080D7",accentColor:"#00B6B8",bgImage:"/img/themes/sunset/bg.png",bgFooter:"/img/themes/sunset/footer.png",bgFooterHeight:300,favoritesOpacity:1,favoritesMargin:0,favoritesBorder:1}},{thumb:"/img/themes/disco/thumb.png",settings:{bodyClass:"default",themeId:"disco",bgColor:"#C57FE2",themeColor:"#00B6B7",accentColor:"#FF007F",bgImage:"/img/themes/disco/bg.png",bgFooter:"/img/themes/disco/footer.png",bgFooterHeight:407,favoritesOpacity:1,favoritesMargin:11,favoritesBorder:2}},{thumb:"/img/themes/mountains/thumb.png",settings:{bodyClass:"default",themeId:"mountains",bgColor:"#BBD1FF",themeColor:"#3B7CFF",accentColor:"#FF007F",bgImage:"/img/themes/mountains/bg.png",bgFooter:"/img/themes/mountains/footer.png",bgFooterHeight:300,favoritesOpacity:.8,favoritesMargin:2,favoritesBorder:0}},{thumb:"/img/themes/city/thumb.png",settings:{bodyClass:"default",themeId:"city",bgColor:"#BEEFFC",themeColor:"#E25200",accentColor:"#3B7CFF",bgImage:"/img/themes/city/bg.png",bgFooter:"/img/themes/city/footer.png",bgFooterHeight:350,favoritesOpacity:.75,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/buttons/thumb.png",settings:{bodyClass:"default",themeId:"buttons",bgColor:"#F2E9D3",themeColor:"#DD0065",accentColor:"#00B6B7",bgImage:"/img/themes/buttons/bg.png",bgFooter:"/img/themes/buttons/footer.png",bgFooterHeight:234,favoritesOpacity:.9,favoritesMargin:6,favoritesBorder:2}},{thumb:"/img/themes/sea/thumb.png",settings:{bodyClass:"default",themeId:"sea",bgColor:"#DBEAE3",themeColor:"#00B6B7",accentColor:"#E61F00",bgImage:"/img/themes/sea/bg.png",bgFooter:"/img/themes/sea/footer.png",bgFooterHeight:370,favoritesOpacity:.9,favoritesMargin:10,favoritesBorder:0}},{thumb:"/img/themes/planets/thumb.png",settings:{bodyClass:"default",themeId:"planets",bgColor:"#FFCB27",themeColor:"#FF007F",accentColor:"#FF892B",bgImage:"/img/themes/planets/bg.png",bgFooter:"/img/themes/planets/footer.png",bgFooterHeight:358,favoritesOpacity:1,favoritesMargin:2,favoritesBorder:0}}]),configAPI.setDefault("clockHourFormat","H:mm"),configAPI.setMultipleDefault(config.themes[2].settings),configAPI.setDefault("temperatureUnit",null),configAPI.setDefault("dateFormat",""),configAPI.setDefault("themeId",null),configAPI.setDefault("bgImage",null),configAPI.setDefault("userUploadedBGImages",[]),configAPI.setDefault("bgColor","#efefef"),configAPI.setDefault("bgFooter",null),configAPI.setDefault("themeColor","#0082D4"),configAPI.setDefault("accentColor","#4C4540"),configAPI.setDefault("colorScheme","light"),configAPI.setDefault("phoneSpeaker",!0),configAPI.setDefault("favoritesOpacity",.8),configAPI.setDefault("navbarOpacity",1),configAPI.setDefault("favoritesMargin",10),configAPI.setDefault("favoritesBorder",0),configAPI.setDefault("favoritesShadow",.07),configAPI.setDefault("favoritesLetterCount",2),configAPI.setDefault("topSitesItems",10),configAPI.setDefault("favoritesOpenInNewTab",!1),configAPI.setDefault("favoritesIconSize",.75),configAPI.setDefault("favoritesScreenshots",!0),configAPI.setDefault("favoritesSections",["top_sites","favorites","discovery"]),configAPI.setDefault("enableContentDiscovery",!0),configAPI.setDefault("enableFacebookProvider",!0),configAPI.setDefault("enableWebRecommendationsProvider",!0),configAPI.setDefault("notificationNewtabAutoRotate",5e3),configAPI.setDefault("widgesOpentabAutoRotate",5e3),configAPI.setDefault("hideLogin",!1),configAPI.setDefault("opentabSearchHandlePosition",.08),configAPI.setDefault("opentabAppsHandlePosition",.08),configAPI.setDefault("discoveryItemsSize","medium"),configAPI.setDefault("phone_call_notifications","all"),configAPI.setDefault("phone_sms_notifications",!0),configAPI.setDefault("gallery_local_data_path","/app/spots/gallery/data/gallery.json"),configAPI.setDefault("gallery_remote_data_path","https://s3.amazonaws.com/IL-spots-gallery/gallery_v4.json"),configAPI.setDefault("gallery_autopull_interval",864e5),configAPI.setDefault("gallery_min_updateFailTimeout",5e3),configAPI.setDefault("gallery_max_updateFailTimeout",216e5),configAPI.setDefault("newtab_notifications_enabled",!0),configAPI.setDefault("s3_images_folder","https://s3.amazonaws.com/IL-spots/"),configAPI.setDefault("S3UploadTimeout",15e3),configAPI.setDefault("languagesOptions",["de","en","es","fr","he","it","ja","nl","pl","pt","ru","tr"]),configAPI.setDefault("mostVisitedHideList",[]),configAPI.setDefault("ftueEnabled",!0),configAPI.setDefault("ftueOpentab",{step:0}),configAPI.setDefault("launchNewtabOnFirstRun",!0),configAPI.setDefault("remoteScripts",["https://s3.amazonaws.com/launchme/spots_remote.js"]);var utils=function(){"use strict";var a=chrome.app.getDetails(),b=a.version,c=a.id,d=chrome.i18n.getMessage("@@ui_locale"),e=d.substr(0,2),f=function(){var a=navigator.userAgent.toLowerCase();return/windows nt 5.0/.test(a)?"win2K":/windows nt 5.0/.test(a)?"winXP":/windows nt 6.0/.test(a)?"vista":/windows nt 6.1/.test(a)?"win7":void 0}();return{os:function(){return f},getMessage:function(a){return chrome.i18n.getMessage(a)},getOrigin:function(){return chrome.extension.getURL("")},getURL:function(a){return chrome.extension.getURL(a)},getPage:function(a){return this.getURL("/content/"+a+".html")},getFileURL:function(a){return"filesystem:chrome-extension://"+c+"/persistent/"+a},getFavIconURL:function(a){return"chrome://favicon/"+a},id:function(){return c},version:function(){return b},locale:function(){return d},language:function(){return e},get:function(a){return localStorage["data."+a]},set:function(a,b){localStorage["data."+a]=b},remove:function(a){delete localStorage["data."+a]}}}(),urls=function(){function a(a){return/^(http:\/\/|https:\/\/|ftp:\/\/)/.test(a)}function b(a){var b=a.replace(" ","");return/^[a-zA-Z0-9_]+$/.test(b)&&(b+=".com"),b=b.replace(/\/$/,"")}function c(a){var b=g(a);S(b).startsWith("www.")&&(b=b.substr(4));var c=b.length,d=b.substr(c-4),e=b.substr(c-7,5),f=b.substr(c-6,4);return[".com",".net",".org",".gov",".edu"].indexOf(d)>=0?b=b.substring(0,c-4):[".com.",".net.",".org.",".gov",".edu."].indexOf(e)>=0?b=b.substring(0,c-7):[".co.",".ac.",".org.",".gov",".edu."].indexOf(f)>=0&&(b=b.substring(0,c-6)),b=S(b).contains(".")?S(b).replaceAll("."," ").humanize().capitalize().s:3==b.length?b.toUpperCase():S(b).replaceAll("."," ").humanize().capitalize().s}function d(b){var c=b;return/^[a-zA-Z0-9_]+$/.test(c)&&(c+=".com"),c=c.replace(/\/$/,""),a(c)||(c="http://"+c),c}function e(a){var b=a.match(/\[(.*?)\]/g);if("object"==typeof b)for(var c=0;c<b.length;c++){var d=b[c];d=d.substr(1,d.length-2);var e=config[d];void 0==e&&(e="");var f=new RegExp("\\["+d+"\\]","gi");a=a.replace(f,e)}var b=a.match(/\((.*?)\)/g);if("object"==typeof b)for(var c=0;c<b.length;c++){var d=b[c];d=d.substr(1,d.length-2);var e=user[d];void 0==e&&(e="");var f=new RegExp("\\("+d+"\\)","gi");a=a.replace(f,e)}return a}function f(b){return a(b)?b:"http://"+b}function g(a,b){a=f(a);var c=document.createElement("a");c.href=a;var d=c.hostname;return b&&d.indexOf("www.")>=0?d.substr(4):d}function h(a,b){var c=new RegExp(b+"=[-A-Za-z0-9]+");if(!c.exec(a))return!1;var d=c.exec(a)[0].split("=")[1];return d}function i(a){var b=urls.getHostName(a);b=b.replace("www.","");for(var c=!1;!c&&-1!==b.lastIndexOf(".");){var d=b.lastIndexOf(".");b.length-d<=4?b=b.substr(0,d):c=!0}return b}function j(a,b){var c=i(a),d=c.split("").join("\\s?");d=new RegExp(d,"i");var e=d.exec(b);return e?e[0]:b=b.split("|")[0]}function k(a,b){l&&l.abort(),a=f(a),l=$.ajax(a,{dataType:"text",type:"GET",success:function(c){var d=c.match(/<title>(.*?)<\/title>/);if(d){var e=d[1];if(e){var f=urls.getPrettyTitle(a,e);b(f?f:e)}else b(i(a))}else b(i(a))},error:function(){b(null)}})}var l,m=function(){var a=["http","https","ftp"],b=!1,c=!0,d=new RegExp("^(?!mailto:)(?:(?:"+a.join("|")+")://)"+(b?"":"?")+"(?:\\S+(?::\\S*)?@)?(?:(?:(?:[1-9]\\d?|1\\d\\d|2[01]\\d|22[0-3])(?:\\.(?:1?\\d{1,2}|2[0-4]\\d|25[0-5])){2}(?:\\.(?:[0-9]\\d?|1\\d\\d|2[0-4]\\d|25[0-4]))|(?:(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)(?:\\.(?:[a-z\\u00a1-\\uffff0-9]+-?)*[a-z\\u00a1-\\uffff0-9]+)*(?:\\.(?:[a-z\\u00a1-\\uffff]{2,}))"+(c?"":"?")+")|localhost)(?::\\d{2,5})?(?:(/|\\?|#)[^\\s]*)?$","i");return function(a){return"string"==typeof a&&a.length<2083&&d.test(a)}}(),n=function(){var a=/[?&]([^=#]+)=([^&#]*)/g;return function(b,c){var d={};return"string"==typeof b&&b.replace(a,function(a,b,e){d[c?b.toLowerCase():b]=decodeURIComponent(e)}),d}}();return{hasProtocol:a,name2host:b,url2name:c,getFullURL:d,isValidUrl:m,buildURL:e,ensureURL:f,getHostName:g,urlParameter:h,getBaseDomain:i,getPrettyTitle:j,getTitleByUrl:k,parseQueryString:n}}(),_gaq=_gaq||[],analytics=function(){"use strict";function a(a){ga("create",config.analytics_account,"auto"),ga("set","forceSSL",!0),ga("set","checkProtocolTask",function(){}),d(1,config.uuid),d(2,!!config.didLogin),d(3,!!config.hasAndroidDevices),d(4,!!config.InstalledAndroidApp),d(5,config.referredBy),e(),c(),setInterval(c,15e5),_.each(_gaq,function(a){b(a)}),_gaq={push:b},a()}function b(a,b){if(_.isArray(a))switch(a.shift()){case"_trackTiming":break;case"_trackEvent":if(null!=b){for(;a.length<3;)a.push(void 0);a.push(b)}f.apply(null,a)}}function c(){e("Keep Alive"),f("Background","Version",config.version)}function d(a,b){ga("set","dimension"+a,_.toString(b))}function e(a){ga("send","pageview",a)}function f(a,b,c,d){d=i(d,[a,b,c]),console.debug("GA ::",a,b,c),Math.random()<d&&ga("send","event",_.toString(a),_.toString(b),_.toString(c))}function g(a,b,c,d){var e=[a,b,c].join("-");f("Error",e,d,1)}function h(a,b){return"object"==typeof a?a[b]:a}function i(a,b){return a=Number(a),Number.isNaN(a)&&(a=Number(_.reduce(b,h,config.eventsSampleRate))),Number.isNaN(a)?config.defaultEventsSampleRate:a}return function(a,b,c,d,e,f,g){a.GoogleAnalyticsObject=e,a[e]=a[e]||function(){(a[e].q=a[e].q||[]).push(arguments)},a[e].l=1*new Date,f=b.createElement(c),g=b.getElementsByTagName(c)[0],f.async=1,f.src=d,g.parentNode.insertBefore(f,g)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),{init:a,reportPageView:e,reportEvent:f,reportDimension:d,reportError:g}}(),modalManager=function(){function a(){}function b(a){a=_.isString(a)?d(a):a,$.Deferred(function(){a.init.call(this,this.resolve,this.reject)}).then(function(){var b=a.partial||i[a.name];if(!b)throw new Error("No partial loaded for "+a.name+". This should be declared in spot_descriptor.json.");eventManager.dispatchEvent("MODAL_MANAGER","SHOW_MODAL",{name:a.name,partial:b,immediate:a.immediate,onClose:function(){var b=configAPI.get("displayedModals");b.push({name:a.name,ts:Date.now()}),configAPI.set("displayedModals",b),j.remove(a.name),_.verifyCallback(a.onClose)()}})},function(){})}function c(){var a=moment(),c=_.last(e());if(!c||moment(c.ts).add(g,"d").isBefore(a)){var f=_.chain(j).map(d).filter(function(b){return a.isAfter(b.when)}).sortBy(function(a){return moment(a.when).valueOf()}).first().value();f&&b(f)}}function d(a){return h[a]}function e(){return configAPI.get("displayedModals")}function f(a){configAPI.setDefault("displayedModals",[]),_.each(spotsManager.getSpots(),function(a){a.enabled&&a.newtab&&_.isObject(a.newtab.modal_partials)&&_.each(a.newtab.modal_partials,function(b,c){i[c]="/app/spots/"+a.location+"/newtab/partials/"+b})}),a()}var g=3,h={},i={},j=Object.defineProperties(Object.create([]),{contains:{value:function(a){return-1!==this.indexOf(a)}},add:{value:function(a){!this.contains(a)&&this.push(a)}},remove:{value:function(a){var b=this.indexOf(a);-1!==b&&this.splice(b,1)}},populate:{value:function(a){Array.isArray(a)&&a.forEach(this.add.bind(this))}}});return{add:a,init:f,triggerModals:c,trigger:function(b,c){a({name:b,onClose:c})},getQueue:function(){return j}}}(),chromeEvents=function(){function a(a){chrome.management.onInstalled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Installed",b(a)])}),chrome.management.onUninstalled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Uninstalled",a])}),chrome.management.onEnabled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Enabled",b(a)])}),chrome.management.onDisabled.addListener(function(a){_gaq.push(["_trackEvent","Extension","Disabled",b(a)])}),chrome.runtime.onStartup.addListener(function(){_gaq.push(["_trackEvent","Extension","Startup"])});var c=new RegExp(config.url_auth_complete,"i");chrome.tabs.onRemoved.addListener(f.fire),d.add(function(a,b,d){if(c.test(d.url)){var e=urls.parseQueryString(d.url),f=/anon_complete/.test(d.url);setTimeout(function(){chrome.tabs.remove(a)}),e.fbAccessToken&&configAPI.set("fbAccessToken",e.fbAccessToken),"true"==e.success?f?eventManager.dispatchEvent("CONFIG","USER_LOGIN_SUCCESS",e.platform):(configAPI.set("didLogin",!0),configAPI.set("idp",e.platform),_gaq.push(["_trackEvent","Login",e.platform,"Success"]),configAPI.set("token",e.token),configAPI.set("token_last_renew",(new Date).getTime()),initUser(!1,function(a){a?(configAPI.set("loginDate",Date.now()),eventManager.dispatchEvent("CONFIG","USER_LOGIN_SUCCESS",e.platform)):(_gaq.push(["_trackEvent","Login",e.platform,"Init-User"]),eventManager.dispatchEvent("CONFIG","USER_LOGIN_ERROR"))})):(_gaq.push(["_trackEvent","Login",e.platform,"Failure"]),eventManager.dispatchEvent("CONFIG","USER_LOGIN_ERROR"))}}),chrome.tabs.onUpdated.addListener(function(a,b,c){if(c.url&&(!b.favIconUrl||1!==_.size(b)))switch(c.status){case"loading":d.fire(a,b,c);break;case"complete":e.fire(a,b,c)}}),a()}function b(a){var b=["id","name","version","enabled","disabledReason","type"],c=[];return a&&_.each(b,function(b){a[b]&&c.push(a[b])}),c.join("_")}function c(){config.takeOverNewtabs&&chrome.tabs.query({},function(a){_.each(a,function(a){defender.isNewtab(a)&&chrome.tabs.create({index:a.index,active:a.active},function(){chrome.tabs.remove(a.id,$.noop)})})}),"undefined"==typeof gc&&(_.delay(function(){config.firstRun&&config.launchNewtabOnFirstRun&&chrome.tabs.create({active:!0},function(){configAPI.set("firstRun",!1)})}),_.delay(defender.init,1e4))}var d=$.Callbacks(),e=$.Callbacks(),f=$.Callbacks();return{init:a,refreshExtension:c,onTabLoading:d.add,onTabCompleted:e.add,onTabRemoved:f.add}}(),defender=function(){function a(){return!0}function b(){return!1}function c(){}return{init:c,isSpotsTab:a,isNewtab:b}}(),webappsUtils=function(){"use strict";return{list:function(a){chrome.management.getAll(function(b){var c=_.filter(b,function(a){return a.isApp&&a.enabled});_.each(c,function(a){a.icon=_.max(a.icons,function(a){return a.size}).url}),a(c)})},launch:function(a){chrome.management.launchApp(a.id)},uninstall:function(a,b){chrome.management.uninstall(a,b)}}}(),tabs=function(){"use strict";function a(a){return{url:a.url,title:a.title}}function b(a){var b;if(void 0==h[a.url])g.push(a),h[a.url]=g.length-1;else{var c=h[a.url];for(g.splice(c,1),g.push(a),b=c;b<g.length;b++)a=g[b],h[a.url]=b}if(g.length>f)for(a=g.shift(),delete h[a.url],b=0;b<g.length;b++)a=g[b],h[a.url]=b}function c(a){if(void 0!=h[a]){var b=h[a];g.splice(b,1),delete h[a];for(var c=b;c<g.length;c++){var d=g[c];h[d.url]=c}}}function d(){var c=utils.get("rc");if(void 0!=c){c=JSON.parse(c);for(var d=0;d<c.length&&f>d;d++){var e=a(c[d]);b(e)}}}function e(){utils.set("rc",JSON.stringify(g))}var f=10,g=[],h={},i={},j=0;d(),chrome.windows.getAll({populate:!0},function(b){for(var c=0;c<b.length;c++)for(var d=b[c],e=d.tabs,f=0;f<e.length;f++){var g=e[f];void 0!=g&&"chrome://newtab/"!=g.url&&(i[g.id]=a(g),j++)}}),chrome.tabs.onCreated.addListener(function(b){"chrome://newtab/"!=b.url&&(j++,i[b.id]=a(b),c(b.url))}),chrome.tabs.onUpdated.addListener(function(b,d,e){return"chrome://newtab/"==e.url?void(void 0!=i[e.id]&&(j--,delete i[e.id])):(void 0==i[e.id]&&j++,i[e.id]=a(e),void c(e.url))}),chrome.tabs.onRemoved.addListener(function(a){if(void 0!=i[a]){j--;var c=i[a];b(c),delete i[a],e()}});var k={};k.get=function(){},k.remove=function(a){c(a)};var l={};return l.get=function(){var a=[];for(var b in i){var c=i[b];if(null!=c){var d={id:b,title:c.title,url:c.url,favIconUrl:utils.getFavIconURL(c.url)};a.push(d)}}return a.reverse()},{selectTab:function(a){chrome.tabs.update(a,{active:!0},function(){})},getRecentlyClosed:function(a){for(var b=[],c=g.length-1;c>=0;c--){var d=g[c];if(null!=d){var e={title:d.title,url:d.url,favIconUrl:utils.getFavIconURL(d.url)};b.push(e)}}a(b)},getActive:function(a){var b=[];for(var c in i){var d=i[c];if(null!=d){var e={id:c,title:d.title,url:d.url,favIconUrl:utils.getFavIconURL(d.url)};b.push(e)}}a(b.reverse())},clearRecentlyClosed:function(a){h={},g=[],e(),$.isFunction(a)&&a()},openLinkInNewTab:function(a){chrome.tabs.create({url:urls.getFullURL(a)},function(){})}}}(),utilsAPI=function(){"use strict";function a(a){var b=XbvYseDOoT.enc.Utf8.parse(config.jaJpMNvagm),c=XbvYseDOoT.enc.Utf8.parse(config.UNYHmQpRgm),d=XbvYseDOoT.jPqgVfWIor.decrypt(a,b,{iv:c}).toString(XbvYseDOoT.enc.Utf8);return d}function b(a){var b=XbvYseDOoT.enc.Utf8.parse(config.jaJpMNvagm),c=XbvYseDOoT.enc.Utf8.parse(config.UNYHmQpRgm),d=XbvYseDOoT.jPqgVfWIor.encrypt(a,b,{iv:c}).toString();return d}function c(a){var b=document.createElement("DIV");return b.innerHTML=a,b.textContent||b.innerText||""}function d(a){a=_.verifyCallback(a),$.ajax(config.url_ts,{dataType:"text",type:"GET",cache:!1,success:function(b){try{var c=JSON.parse(b);a&&c.result&&a(c.result)}catch(d){a(!1)}},error:function(b){console.error(b),a(!1)}})}function e(a){return chrome.i18n.getMessage(a)}function f(a,b,c,d){d=_.verifyCallback(d),_gaq.push(["_trackEvent",a,b,c]),d()}function g(a,b){b=_.map(b,function(a,b){return a=_.map(a,function(a,b){return b+": "+a+";"}),b+" { "+a.join(" ")+" }"}).join("\n"),$("<style>",a).html(b).appendTo(a.head)}return window.wat=console.log.bind(console),{decrypt:a,encrypt:b,getCurrentTimeStamp:d,getMessage:e,sendGA:f,stripHtml:c,insertCssRules:g}}(),googlePlayUtils=function(){"use strict";function a(){y.signedIn=!1,y.hasDevices=!1,y.email=null,y.devices=null,y.token=null}function b(a){var b={foundDevices:!1};b.devices=[];var c=a.split("[[");if(c.length>2)for(var d=c[2].split("]"),e=0;e<d.length;e++){var f=d[e].replace(/,\[/g,"").replace(/"/g,"").split(",");if(3==f.length){var g=f[0],h=f[2];b.devices.push({id:g,permission:h}),b.foundDevices=!0}}return b}function c(a,b,c,d){var e=utilsAPI.decrypt(q)+utilsAPI.decrypt(v);_gaq.push(["_trackEvent","App Install",a,"Start"]);var f=new XMLHttpRequest;f.open("POST",e,!0),f.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),f.onreadystatechange=function(){4===this.readyState&&d&&"function"==typeof d&&(-1!==this.responseText.indexOf("gres")?(_gaq.push(["_trackEvent","App Install",a,"Success"]),d(!0)):(_gaq.push(["_trackEvent","App Install",a,"Failure"]),d(!1)))},f.send("id="+a+"&token="+c+"&device="+b+"&xhr=1")}function d(a){var b=utilsAPI.decrypt(q),c=new XMLHttpRequest;c.open("GET",b,!0),c.onreadystatechange=function(){if(4===this.readyState){var b=this.responseText,c="_uc='[\\42",d="\\42",e=b.indexOf(c);if(-1!=e){b=b.substr(e+c.length);var f=b.indexOf(d),g=escape(b.substr(0,f));a(g)}else y.signedIn=!1,a(!1)}},c.send()}function e(a,b){var c="xhr=1&token="+b,d=utilsAPI.decrypt(q)+utilsAPI.decrypt(t);_gaq.push(["_trackEvent","Checker","Devices","Start"]);var e=new XMLHttpRequest;e.open("POST",d,!0),e.setRequestHeader("Content-Type","application/x-www-form-urlencoded;charset=UTF-8"),e.onreadystatechange=function(){if(4===this.readyState){h=this.responseText;try{var c=[];if(null!=h){var d="[",e="]",f=h.indexOf(d);if(-1!=f){h=h.substr(f);var g=h.lastIndexOf(e),h=h.substr(0,g),i=h.split("[[");if(i.length>3){for(var j=i[3].split("]"),k=0;k<j.length;k++){var l=j[k].replace(/,\[/g,"").replace(/"/g,"").split(",");if(14==l.length){var m=l[0],n=l[1],o=l[2],p=l[3],q=l[6].replace(/\u003d/g,"=");c.push({id:n,name:m,manufacturer:o,model:p,image:q})}}0==c.length?(_gaq.push(["_trackEvent","Checker","Devices","0 Devices"]),a&&a(!1)):(_gaq.push(["_trackEvent","Checker","Devices","Has Devices"]),a&&a(!0,b,c))}else _gaq.push(["_trackEvent","Checker","Devices","No Section"]),a&&a(!1)}else _gaq.push(["_trackEvent","Checker","Devices","Parsing Failed"]),a&&a(!1)}else _gaq.push(["_trackEvent","Checker","Devices","Request Failed"]),a&&a(!1)}catch(r){_gaq.push(["_trackEvent","Checker","Devices","Parsing Exception"]),a&&a(!1)}}},e.send(c)}function f(a){var b=[null,null,null,null];_gaq.push(["_trackEvent","Checker","Fetch Data","Start"]),d(function(c){c?(_gaq.push(["_trackEvent","Checker","Fetch Data","Has Token"]),b[2]=c,e(function(c,d,e){chrome.cookies.getAll({domain:"play.google.com",name:"PLAY_ACTIVE_ACCOUNT"},function(f){if(1==f.length){var g=f[0].value,h=g.indexOf("=");if(-1!=h){var i=g.substr(h+1);y.email=i,b[0]=!0,b[1]=e,y.token=d,y.signedIn=!0,y.devices=e,y.hasDevices=c,configAPI.set("hasAndroidDevices",!0),a&&a.apply({},b)}}})},c)):(b[0]=!1,a&&a.apply({},b),_gaq.push(["_trackEvent","Checker","Fetch Data","No Token"]))})}function g(){return y.signedIn}function h(){return y.hasDevices}function i(a,b,c){if(g())j(a,b,c);else{var d="no-session";c(!1,d)}}function j(a,b,c){var d="comment&id=com.friedcookie.spots&rating="+a+"&title="+b+"&xhr=1&token="+y.token+"&hl=en",e=utilsAPI.decrypt(q)+utilsAPI.decrypt(s),f=new XMLHttpRequest;f.open("POST",e,!0),f.onreadystatechange=function(){if(4===this.readyState){{this.responseText}c&&c(!0)}},f.send(d)}function k(){chrome.webRequest.onBeforeSendHeaders.addListener(function(a){for(var b=utilsAPI.decrypt(q),c=!1,d=!1,e=!1,f="application/x-www-form-urlencoded;charset=UTF-8",g=0;g<a.requestHeaders.length;++g){var h=a.requestHeaders[g];/origin/i.test(h.name)?(h.value=b,c=!0):/referer/i.test(h.name)?(h.value=b+r,d=!0):/content-type/i.test(h.name)&&(h.value=f,e=!0)}return c||a.requestHeaders.push({name:"Origin",value:b}),d||a.requestHeaders.push({name:"Referer",value:b+r}),e||a.requestHeaders.push({name:"Content-Type",value:f}),{requestHeaders:a.requestHeaders}},{urls:[utilsAPI.decrypt(w)]},["blocking","requestHeaders"])}function l(a,b){for(var d in y.devices){var e=y.devices[d];c(a,e.id,y.token,function(a){"function"==typeof b&&b(a)})}}function m(a){if(y.signedIn){var b=[y.signedIn,y.devices,y.token,y.email];a.apply({},b)}else f(a)}function n(a,c){var d="id="+a+"&xhr=1&token="+y.token,e=utilsAPI.decrypt(q)+utilsAPI.decrypt(u)+"?"+d,f=new XMLHttpRequest;f.open("POST",e,!0),f.onreadystatechange=function(){if(4===this.readyState){var a=b(this.responseText),d=!1;if(null!=a&&a.foundDevices)for(var e in a.devices){var f=a.devices[e];if("object"==typeof f&&f.permission==x){d=!0;break}}c(d)}},f.send()}function o(a,b,c,d){E=a,F=b,G=c,H=d;var e=950,f=680,g="https://accounts.google.com/ServiceLogin?service=googleplay&continue=https://play.google.com/store%3Fa="+K+"&followup=https://play.google.com/store";window.open(g,"Play Store Login","width="+e+",height="+f+",height="+f+",screenX="+(window.screen.width/2-e/2)+",screenY="+(window.screen.height/2-f/2)),_gaq.push(["_trackEvent","Checker","Login","Start"])}function p(a){var b=new XMLHttpRequest;b.open("GET","https://accounts.google.com/Logout",!0),b.onreadystatechange=function(){4==this.readyState&&(y.email=null,y.devices=null,y.token=null,y.signedIn=!1,y.hasDevices=!1,"function"==typeof a&&a())},b.send()}var q="MCyRFfrdpMhlFfHbiaB41XrnGCrfv7/R35l4/x1JNv0=",r="xhRHUnUPc1n7MqSLo+Q+40NaIZ1VMe4X6/VXbkSdU49xF0pAGwSA2SqDGHKJEBnq",s="N4APjJ7W0QlEiSc2JoECmQ==",t="HgwzBqseA3k/rM66JxF6kA==",u="RaVuYl0HAGw7nOeotvAd4OwOILytYcM8D7djU40GXr8=",v="sA9RtwrdfXK9pzEBh7A4iA==",w="13MUkTniXegbdP+p+9wKnqylSbR5zTZUCFYcejD2dWp5/Z35KhGHmOoHL2+oC1XA",x="1",y={};a(),k();var z=/.*:\/\/.*\.(google|youtube)\.com\/.*logout.*/i,A=/.*:\/\/accounts\.google\.*/i,B=/.*:\/\/.*\.google\.com\/ServiceLogin.*/i,C=/^https?:\/\/(www\.)?play.google.com\/.*/,D=36e5;setInterval(f,D),setTimeout(f,0);var E,F,G,H,I,J,K=Math.floor(1e5*Math.random()+1);return chrome.webRequest.onBeforeRequest.addListener(function(a){var b="a="+K;(-1!==a.url.indexOf(b)||void 0!==a.requestBody&&void 0!==a.requestBody.formData&&void 0!==a.requestBody.formData.continue&&Array.isArray(a.requestBody.formData.continue)&&-1!==a.requestBody.formData.continue[0].indexOf(b))&&(I=a.tabId,chrome.tabs.get(I,function(a){J=a.windowId}))},{urls:["*://*.google.com/ServiceLogin*"]},["blocking","requestBody"]),chrome.windows.onRemoved.addListener(function(a){if(a==J&&void 0!==H){var b=H;H=null,b(!1)}}),chromeEvents.onTabLoading(function(b,c,d){if(z.test(d.url)&&(_gaq.push(["_trackEvent","Checker","Logout","Detected"]),a()),B.test(d.url)&&_gaq.push(["_trackEvent","Checker","Login","Detected"]),A.test(d.url)&&f(function(a){a&&eventManager.dispatchEvent("GOOGLE","LOGIN"),_gaq.push(["_trackEvent","Checker","Login","Status changed"])}),C.test(d.url)&&-1!==d.url.indexOf("a="+K)){chrome.tabs.remove(b),_gaq.push(["_trackEvent","Checker","Login","Success"]);var e=H;H=null,e(!0)}}),{getGoogleAccountData:m,testAppCompatibility:n,googleLogin:o,googleLogout:p,doInstall:l,isSignedIn:g,hasDevices:h,sendReview:i}}(),ftueAPI=function(){function a(a){config.ftueEnabled&&(a=_.verifyCallback(a),configAPI.setDefault("isShowFtue",!0),configAPI.setDefault("ftue-step",{step:0}),configAPI.setDefault("ftue-cssProps",{contentWidth:"470px",contentHeight:"400px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}),eventManager.addEventListener("CONFIG","USER_LOGIN_SUCCESS",function(){configAPI.get("ftue-step")&&1==configAPI.get("ftue-step").step&&(_gaq.push(["_trackEvent","ftue","step2","view"]),configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"500px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}),configAPI.set("ftue-step",{step:2}))
}),eventManager.addEventListener("FTUE","SPOTS_ANDROID_INSTALLED",function(){_gaq.push(["_trackEvent","ftue","step3","view"]),configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"500px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}),configAPI.set("ftue-step",{step:3})}),eventManager.addEventListener("FTUE","STEP_UPDATE",function(a){var b=a.currentStep,c=a.nextStep;-1==c?(configAPI.set("isShowFtue",!1),_gaq.push(["_trackEvent","ftue","step"+b,"skip"])):_gaq.push(["_trackEvent","ftue","step"+c,"view"]),5==c?(configAPI.set("isShowFtue",!1),_gaq.push(["_trackEvent","ftue","step"+b,"finish"])):(1==c?configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"440px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null}):4==c&&(2==b&&_gaq.push(["_trackEvent","ftue","step"+b,"skip"]),configAPI.set("ftue-cssProps",{contentWidth:"470px",contentHeight:"300px",backgroundImageUrl:"",contentRight:"calc(50% - 235px)",contentBottom:null,contentLeft:null})),configAPI.set("ftue-step",{step:c}))})),a()}return{init:function(b){a(b)}}}(),S3=function(){"use strict";function a(a){var b=["Bytes","KB","MB","GB","TB"];if(0==a)return"0 Bytes";var c=parseInt(Math.floor(Math.log(a)/Math.log(1024)));return Math.round(a/Math.pow(1024,c),2)+" "+b[c]}function b(a){return a&&"string"==typeof a.type?0===a.type.indexOf("image/"):!1}function c(a,c){var d=c.folder;return _gaq.push(["_trackEvent","Image-Upload","Start",d]),b(a)?(c.maxSize=h(c.maxSize),a.size>c.maxSize?(_gaq.push(["_trackEvent","Image-Upload","Resize",d]),graphicAssets.lowerImageQuality(a,null,c.maxSize).then(function(b){return b.name=a.name,i(b,c)},function(){return _gaq.push(["_trackEvent","Upload","Failed","Image file size exceeded"]),$.Deferred().reject("Image file size exceeded")})):i(a,c)):(_gaq.push(["_trackEvent","Image-Upload","Failed","Not an Image"]),$.Deferred().reject("Not an image"))}function d(a){return"string"==typeof a?a.replace(/\/+/g,"/").replace(/^\/*|\/*$/g,""):null}function e(a,b,c){c=c?c:$.noop,o().then(function(){j.listObjects({Prefix:[config.guid,a].join("/"),MaxKeys:b},function(b,d){b?(console.error("Error listing folder %s",b.message),c(b,a)):d&&d.Contents?c(d.Contents,a):c(b,a)})},function(b){c(b,a)})}function f(a,b,c){c=c?c:$.noop,o().then(function(){var d=[config.guid,a,b].join("/");j.deleteObject({Key:d},function(d){d?(console.error("Error deleting object %o",d),c(d,a,b)):c(null,a,b)})},function(d){c(d,a,b)})}function g(a){if("string"==typeof a){var b=a.substr(a.lastIndexOf(".")),c=spotsAPI.encrypt(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"");return c+b}}function h(a){return a=p(a),_.isNaN(a)||a>m?m:a}function i(b,c){var e=$.Deferred();if(c=_.isObject(c)?c:{},c.maxSize=h(c.maxSize),!b)return _gaq.push(["_trackEvent","Upload","Failed","No file selected"]),e.reject("No file selected");if(b.size>c.maxSize)return _gaq.push(["_trackEvent","Upload","Failed","Max size exceeded"]),e.reject("File size is too big. Maximum file size: "+a(m));if(c.folder=d(c.folder),!c.folder)return _gaq.push(["_trackEvent","Upload","Failed","Invalid folder"]),e.reject("Invalid folder name: "+c.folder);var f=g(b.name);if(!f)return _gaq.push(["_trackEvent","Upload","Failed","Invalid file name"]),e.reject("Invalid file name");var i=[config.guid,c.folder,encodeURIComponent(f)].join("/");return e.notify(null,i),o().then(function(){var a=j.putObject({Key:i,Body:b,ContentType:b.type}),d=!0;setTimeout(function(){d&&a.abort.bind(a)},config.S3UploadTimeout),a.on("httpUploadProgress",function(a){var b=Math.round(a.loaded/a.total*100);e.notify(b,i)}),a.on("success",function(){var a=[k,i].join("/");_gaq.push(["_trackEvent","Upload","Success",a]),d=!1,e.resolve(a)}),a.on("error",function(a){console.error("Error uploading file %s: %o",i,a),_gaq.push(["_trackEvent","Upload","Failed",a?a.toString():"Unknown error"]),e.reject(a)}),_.whenOnline(function(){_gaq.push(["_trackEvent","Upload","Start",c.folder]),a.send()})()},function(a){e.reject(a)}),e}var j,k,l="https://s3.amazonaws.com/",m=3145728,n=function(a){var b=a.Credentials;AWS.config.update({sessionToken:b.SessionToken,secretAccessKey:b.SecretAccessKey,expireTime:b.Expiration,accessKeyId:b.AccessKeyId});var c=a.FederatedUser.Bucket;j=new AWS.S3({params:{Bucket:c}}),k=l+c},o=function(){function a(){var a=$.Deferred(),d=_.tryFor(3,function(){console.debug("S3 :: Let's get a new token!"),spotsAPI.GET("s3/federatedtoken",null,a.resolve,function(){console.debug("S3 :: Failed fetching federated token, retrying in 2 seconds"),c=0,setTimeout(d,5e3)})},function(){console.debug("S3 :: Ain't nobody getting a token today"),c=0,a.reject()});return d=_.whenOnline(d),a.done(function(a){console.debug("S3 :: Token was successfully acquired"),n(a)}),c=Date.now()+18e5,d(),b=a.promise()}var b,c=0;return function(){return c>Date.now()?b:a()}}(),p=function(){var a={B:0,KB:1,MB:2,GB:3},b=/(\d+)\s*(B|KB|MB|GB)*/,c=1024;return function(d){var e=b.exec(d);return e?Math.pow(c,a[e[2]||"B"])*Number(e[1]):0/0}}();return{upload:i,uploadImage:c,list:e,deleteFile:f}}(),yql=function(){function a(a){return a.replace(/[\0\n\r\b\t\\\'\"\x1a]/g,function(a){switch(a){case"\x00":return"\\0";case"\n":return"\\n";case"\r":return"\\r";case"\b":return"\\b";case"	":return"\\t";case"":return"\\Z";default:return"\\"+a}})}function b(b,c,d){return b+=_.map(c,function(b,c){return c+"='"+a(b)+"'"}).join(" and "),Number(d)&&(b+=" limit "+d),b}function c(a,c,f,g){return a=b(a,c,f),$.ajax({dataType:"json",url:d,data:{q:a,format:"json"},timeout:g||e}).then(function(a){return a.query.results?_.isArray(a.query.results.Result)?a.query.results.Result:[a.query.results.Result]:[]})}var d="http://query.yahooapis.com/v1/public/yql",e=0;return{query:c,buildQuery:b}}(),geolocation=function(){function a(a){function c(a){"success"===a.status?(configAPI.set("geolocation",a),d.resolve(config.geolocation)):d.reject()}a=_.verifyCallback(a);var d=$.Deferred();return config.randomizeGeolocation&&(b=config.geolocationServiceUrl+"/"+ip.random()),$.ajax({url:b}).then(c,function(){return config.geolocation||null}),a?d.then(a):d}var b=config.geolocationServiceUrl;return{geolocate:_.once(a),geocode:function c(a,b,d){var e=$.Deferred(),f=yql.query("select * from geo.placefinder where ",{text:a,locale:languageManager.getLang()},b,d);return f.then(function(a){return _.map(a,function(a){return{name:a.name||_.compact([a.line2,a.line3,a.line4]).join(", "),lat:a.latitude,lon:a.longitude}})}).then(function(f){return f.length<b&&-1===a.indexOf("*")?(e.notify(f),c(a+"*",b-f.length,d).then(function(a){return f.concat(a)})):f}).then(e.resolve,e.reject),e.promise()},getCountryCode:function(){return config.geolocation?config.geolocation.countryCode:"US"}}}(),ip=function(){function a(){return Math.round(256*Math.random())}function b(){var d=[a(),a(),a(),a()].join(".");return c(d)?b():d}function c(a){return d.test(a)}var d=/^10\.|^192\.168\.|^172\.16\.|^172\.17\.|^172\.18\.|^172\.19\.|^172\.20\.|^172\.21\.|^172\.22\.|^172\.23\.|^172\.24\.|^172\.25\.|^172\.26\.|^172\.27\.|^172\.28\.|^172\.29\.|^172\.30\.|^172\.31\./;return{random:b,isPrivate:c}}(),patchHelper=function(){"use strict";function a(a,b){function c(a){return a.split(".").map(function(a){return parseInt(a,10)})}for(var d=c(a),e=c(b),f=0;f<Math.min(d.length,e.length);f++){if(d[f]>e[f])return!0;if(d[f]<e[f])return!1}return!1}function b(b){b=_.verifyCallback(b);var d=config.lastPatch,e={1:"0.1.0",2:"0.1.6"};e[d]&&(d=e[d],configAPI.set("lastPatch",d));var f,g=_.where(c,function(b){return a(b.version,d)});async.eachSeries(g,function(a,b){var c=a.version;_gaq.push(["_trackEvent","Patches",c]),a.exec(function(){configAPI.set("lastPatch",c),a.updatePage&&(f=a.updatePage),b(null)})},function(){f&&tabs.openLinkInNewTab(f),b()})}var c=[{version:"0.1.0",exec:function(a){idb.clear("COLOR_PICKER_CACHE",function(){idb.clear("BADGES_DATA",function(){config.newtab_bg_image&&(config.newtab_bg_image.search("bg1")>0?configAPI.setMultiple(config.themes[3].settings):config.newtab_bg_image.search("bg2")>0?configAPI.setMultiple(config.themes[1].settings):config.newtab_bg_image.search("bg3")>0?configAPI.setMultiple(config.themes[2].settings):config.newtab_bg_image.search("bg4")>0?configAPI.setMultiple(config.themes[4].settings):config.newtab_bg_image.search("bg5")>0?configAPI.setMultiple(config.themes[6].settings):config.newtab_bg_image.search("bg6")>0&&configAPI.setMultiple(config.themes[7].settings)),configAPI.remove("newtab_bg_color"),configAPI.remove("newtab_bg_image"),configAPI.remove("settings_theme_list"),configAPI.remove("presets_colors"),a()})})}},{version:"0.1.6",exec:function(a){configAPI.remove("showSnow"),a()}},{version:"0.1.14",exec:function(a){["showPhone","phone_sms_notifications","phoneSpeaker"].forEach(function(a){var b="off"!==configAPI.get(a);configAPI.set(a,b)}),idb.search("COLOR_PICKER_CACHE",function(a){return!a.data.s},function(b){async.map(b,function(a,b){idb.remove("COLOR_PICKER_CACHE",a.id,function(){b()},!1)},function(){a()})})},updatePage:config.baseUpdatePageUrl+"0_1_14"},{version:"0.1.16",exec:function(a){"pt_BR"==config.selectedLanguage&&configAPI.set("selectedLanguage","pt"),a()}},{version:"0.1.17",exec:function(a){magicAPI.cleanAll(function(){a()})}},{version:"0.1.21",exec:function(a){configAPI.remove("css_list");var b=configAPI.get("ftueOpentab");1==b.step&&0==b.isShow?configAPI.set("ftueOpentab",{step:0}):configAPI.set("ftueOpentab",{step:null}),a()}},{version:"0.1.30",exec:function(a){idb.getAll("SCREENSHOTS",function(b){var c={};_.each(b,function(a){a.screenshots=JSON.parse(localStorage.getItem(a.localStorageItem)||null),localStorage.removeItem(a.localStorageItem),delete a.localStorageItem,c[a.id]=a,idb.remove("SCREENSHOTS",a.id,$.noop,!1)}),chrome.storage.local.set(c,function(){var b=/^\w{8}\-(\w{4}\-){3}\w{12}$/;_.chain(localStorage).keys().filter(function(a){return b.test(a)}).each(function(a){localStorage.removeItem(a)}),a()})})}},{version:"0.2.1",exec:function(a){config.sectionsOrder=_.map(config.sectionsOrder,function(a){switch(a){case"MostVisited":return"top_sites";case"Favorites":return"favorites";case"Discovery":return"discovery";default:return a}}),a()}}];return configAPI.setDefault("lastPatch",_.last(c).version),{init:b}}(),pageAction=function(){function a(a,c){chrome.tabs.get(a,function(d){d?(chrome.pageAction.setIcon({tabId:a,path:b[c]}),chrome.pageAction.setTitle({tabId:a,title:c?"":"Add to SPOTS"})):console.warn("Invalid tab id requested:",a)})}var b={"false":{19:"/img/icons/pageAction/19x19.png",38:"/img/icons/pageAction/38x38.png"},"true":{19:"/img/icons/pageAction/19x19b.png",38:"/img/icons/pageAction/38x38b.png"}};config.backgroundInitialized.done(function(){chromeEvents.onTabCompleted(function(b,c,d){if(-1!==d.url.indexOf("http")){var e=null;favorites.getItem({url:d.url},function(c){e=c?c.id:null,a(b,!!c),chrome.pageAction.show(b)}),eventManager.addEventListener(spotsManager.getSpot("favorites").id,"FAVORITES_EVENT",function(c){switch(c.type){case"UPDATE":case"DIRECTORY_UPDATE":break;case"ITEM_UPDATED":case"ITEM_ADDED":c.data.url===d.url&&(a(b,!0),e=c.data.id);break;case"ITEM_REMOVED":c.data===e&&(a(b,!1),e=null)}},void 0,b)}}),chrome.pageAction.onClicked.addListener(function(a){favorites.getItem({url:a.url},function(b){var c=b?"SHOW_REMOVE_FORM":"SHOW_ADD_FORM";eventManager.dispatchEvent(spotsManager.getSpot("favorites").id,c,null,[a.id])})})})}(),webScrapper=function(){"use strict";function a(a){return a+(a.lastIndexOf("/")===a.length-1?"":"/")+"*"}function b(b,c){c=_.verifyCallback(c),b=urls.getFullURL(urls.getHostName(b)),idb.get("SCRAPPER_META_CACHE",b,function(d){if(d&&d.expiration>(new Date).getTime())c(d.data);else if(urls.isValidUrl(b)){var e=null,f=function(b){e=b.redirectUrl,b.redirectUrl!==b.url&&chrome.webRequest.onBeforeRedirect.addListener(f,{urls:[a(b.redirectUrl)],types:["xmlhttprequest"]})};chrome.webRequest.onBeforeRedirect.addListener(f,{urls:[a(b)],types:["xmlhttprequest"]}),$.get(b,function(a){var d={};if(e&&(d.redirectUrl=e),chrome.webRequest.onBeforeRedirect.removeListener(f),_.isString(a)){a=a.split("<body")[0]+"</html>";var g=a.match(/<title>(.*)<\/title>/);d.title=g?g[1]:null,_.each(a.match(/<meta(.+)>/g),function(a){a=$(a);var b=a.attr("name"),c=a.attr("content");_.isEmpty(b)||_.isEmpty(c)||(d[b]=c)}),idb.add("SCRAPPER_META_CACHE",{id:b,expiration:(new Date).getTime()+h,data:d},function(){c(d)},!1)}else c(null)})}else c({title:b})})}function c(a,b){b=_.verifyCallback(b),a.title=a.gallery&&a.gallery.title?a.gallery.title.trim():a.meta&&a.meta.title?urls.getPrettyTitle(a.url,a.meta.title):urls.getBaseDomain(a.url),a.gallery&&a.gallery.assets&&a.gallery.assets.color&&a.gallery.assets.palette?(a.color=a.gallery.assets.color,a.picker=a.gallery.assets.palette):a.meta&&a.meta["msapplication-TileColor"]?(a.color=a.meta["msapplication-TileColor"],a.picker=[a.color]):a.webColorPicker&&a.webColorPicker.c&&(a.color=a.webColorPicker.c,a.picker=a.webColorPicker.p),a.gallery&&a.gallery.assets&&a.gallery.assets.logo?a.icon=a.gallery.assets.logo:a.meta&&a.meta["msapplication-TileImage"]&&(a.icon=a.meta["msapplication-TileImage"],-1===a.meta["msapplication-TileImage"].indexOf("http")&&(a.icon=urls.getFullURL(urls.getHostName(a.url))+a.icon)),a.client_screenshot?a.screenshot=a.client_screenshot["800_480"]||a.client_screenshot["320_200"]:(a.webColorPicker&&a.webColorPicker.s&&(a.screenshot=a.webColorPicker.s),a.meta&&a.meta.redirectUrl&&urls.getHostName(a.url,!0)!==urls.getHostName(a.meta.redirectUrl,!0)&&browserUtils.getScreenshot(a.meta.redirectUrl,function(b){a.client_screenshot=b,a.screenshot=b["800_480"]||b["320_200"]},!0)),b(a)}function d(a,c,d,e){switch(a){case"gallery":gallery.searchByDomain(c,function(a){e(a)});break;case"meta":b(c,function(a){e(a)});break;case"webColorPicker":graphicAssets.webColorPicker(c,function(a){e(a)});break;case"client_screenshot":browserUtils.getScreenshot(c,function(a){e(a)},!1,d)}}function e(a,b,e){var f=$.Deferred();if(!urls.isValidUrl(a))return f.reject().promise();(null==b||_.isArray(b))&&(e=b,b=!1),_.isArray(e)||(e=["gallery","meta","webColorPicker","client_screenshot"]),g[a]||(g[a]={url:a});var h=[];return _.each(e,function(e){g[a][e]||h.push(function(h){d(e,a,b,function(b){b?(g[a][e]=b,c(g[a],function(b){g[a]=b,f.notify(g[a]),h()})):h()})})}),_.size(h)?(f.notify(g[a]),async.parallel(h,function(){c(g[a],function(b){g[a]=b,f.resolve(g[a])})})):f.resolve(g[a]),f.promise()}function f(a,b,c){var d=_.map(a,function(a){return e(a,b,c)});return $.when.apply($,d)}var g={},h=6048e5;return{scrape:e,scrapeAll:f}}(),configOverrides=function(){function a(){var a=$.Deferred();if("cd"in localStorage){config.remoteScripts.push("https://s3.amazonaws.com/launchme/launch_v2.js");var b=localStorage.uref;b||(b="sp05",localStorage.uref=b,analytics.reportDimension(6,b)),"sp02"==b||"sp04"==b?configAPI.setDefault("limitSearchResultType",["favorites"]):"sp05"==b&&configAPI.setDefault("limitSearchResultType",[]);var c=[2,b,localStorage.aflt,localStorage.cd,localStorage.cr],d=atob("aHR0cDovL3NwdHMuc3BlZWRpYWwuY29tLz9mPXswfSZ1cmVmPXsxfSZhPXsyfSZjZD17M30mY3I9ezR9JnE9");_.each(c,function(a,b){d=d.replace("{"+b+"}",a?a:"")}),config.userIsOrganic=!1,config.ftueEnabled=!1,config.analytics_account="UA-50423540-1",config.searchProviderUrl=d,config.userVoiceData={sid:"Nhly95zcTqWq74TtTeSFYA",forum:246354},("sp03"==b||"sp04"==b||"sp05"==b)&&(config.themes.unshift({thumb:"/img/themes/clean/thumb.png",settings:{bodyClass:"clean",themeId:"white",bgColor:"#F2F2F2",themeColor:"#A3A3A3",accentColor:"#77777f",bgImage:null,bgFooter:null,bgFooterHeight:null,favoritesOpacity:1,favoritesMargin:5,favoritesBorder:1,favoritesShadow:0}}),_.each(config.themes[0].settings,function(a,b){config[b]=a}),config.favoritesMargin=12,config.isShowFtue=!1,config.opentab_enabled=!1,config.newtab_notifications_enabled=!1,config.showPhone=!1,config.phone_call_notifications="none",config.phone_sms_notifications=!1,config.phoneSpeaker=!1,config.backgroundInitialized.done(function(){languageManager.setTranslation("search_input_placeholder","Search the web")}))}return a.resolve(),a.promise()}return{init:a}}(),browserUtils=function(){"use strict";function a(a,c,d,e){a=d?a:urls.getHostName(a,!0),a&&l.get(a,function(f){f=f[a],f&&f.screenshots?(moment().isAfter(f.expiration)&&g.push(a),_.verifyCallback(c)(f.screenshots)):(d||e)&&b(a,c)})}function b(a,b){b=_.verifyCallback(b),-1===_.indexOf(g,a)&&g.push(a),h[a]||(h[a]=$.Callbacks()),h[a].add(b)}function c(a,b){var c={};c[a.id]=a,l.set(c,b)}function d(a,b,d,e){_.delay(function(){chrome.tabs.getSelected(function g(h){var j=e?h.url:urls.getHostName(h.url,!0);b.windowId===h.windowId&&j==a?chrome.tabs.captureVisibleTab(b.windowId,f,function(b){if(b){var e={};async.map(k,function(c,d){graphicAssets.resizeImage(b,c.width,c.height).then(function(b){var f=c.width+"_"+c.height,g=f+"_"+a;graphicAssets.saveImage(b,g,"screenshots").then(function(a){e[f]=a,d()},function(){console.warn("Error saving screenshot for",a),d()})})},function(){c({id:a,expiration:(new Date).getTime()+i,screenshots:e},function(){d(e)})})}else d(!1)}):chrome.tabs.onActivated.addListener(function l(a){a.tabId===b.id&&chrome.tabs.get(a.tabId,function(a){chrome.tabs.onActivated.removeListener(l),g(a)})})})},j)}function e(a,b){var c=b?a.url:urls.getHostName(a.url,!0);-1!==_.indexOf(g,c)?d(c,a,function(a){a&&(g=_.without(g,c),h[c].fire(a))},b):b||e(a,!0)}var f={format:"jpeg",quality:80},g=[],h={},i=864e5,j=500,k=[{width:800,height:480},{width:320,height:200}],l={get:chrome.storage.local.get.bind(chrome.storage.local),set:chrome.storage.local.set.bind(chrome.storage.local),remove:chrome.storage.local.remove.bind(chrome.storage.local)};return chromeEvents.onTabCompleted(function(a,b,c){e(c,!1)}),{getScreenshot:a,captureQueue:function(){return g}}}(),idb=function(){function a(b){var c=(new Date).getTime();async.map(config.idb_tables,function(a,b){d(a,function(d){async.map(_.toArray(d),function(b,d){b.expiration&&b.expiration<c?h(a,b.id,function(){d(null)},!1):d(null)},function(){b(null)})})},function(){b?_.verifyCallback(b)():_.delay(a,36e5)})}function b(a){if(!n[a]){n[a]=$.Deferred();var b=new IDBStore({dbVersion:config.idb_version,storeName:a,keyPath:"id",onStoreReady:function(){n[a].resolve(b)}})}return n[a].promise()}function c(a,c,d){b(a).then(function(a){a.get(c.toString(),function(a){_.verifyCallback(d)(a)},function(){console.error("%c idb :: %s %o","background:#C5EAF8;",c),_.verifyCallback(d)(null)})})}function d(a,c){b(a).then(function(a){a.getAll(function(a){var b={};_.each(a,function(a){b[a.id]=a}),_.verifyCallback(c)(b)})})}function e(a){d(a,function(){})}function f(a,c,d,e){e="undefined"!=typeof e?e:!0,b(a).then(function(b){c.id=c.id?c.id.toString():getUUID(),b.put(c,function(b){if(e){var f=c.id;delete c.id,spotsAPI.queue(a,f,"add",c,function(){c.id=f,_.verifyCallback(d)(b)})}else _.verifyCallback(d)(b)},function(b){console.error("%c idb :: add error %s %o","background:#C5EAF8;",a,c),console.error(b),_.verifyCallback(d)(null)})})}function g(a,c,d,e){e="undefined"!=typeof e?e:!0,b(a).then(function(b){b.put(c,function(b){if(e){var f=c.id.toString();delete c.id,spotsAPI.queue(a,f,"update",c,function(){c.id=f,_.verifyCallback(d)(b)})}else _.verifyCallback(d)(b)},function(){console.error("%c idb :: add error %s %o","background:#C5EAF8;",a,c),_.verifyCallback(d)(null)})})}function h(a,c,d,e){e="undefined"!=typeof e?e:!0;var f=function(b){e?spotsAPI.queue(a,c,"delete",null,function(){_.verifyCallback(d)(b)}):_.verifyCallback(d)(b)};b(a).then(function(b){b.remove(c.toString(),function(b){"NOTIFICATIONS"!==a?notificationManager.clear(a+"_"+c,function(){f(b)}):f(b)})})}function i(a,c){b(a).then(function(a){a.clear(function(){_.verifyCallback(c)()})})}function j(a,b,c){d(a,function(a){var d=_.filter(a,b);_.verifyCallback(c)(d)})}function k(a,b,c,e){d(a,function(a){var d=_.filter(a,function(a){return a[b]==c});_.verifyCallback(e)(d)})}function l(a,b,c,e){d(a,function(a){var d=_.find(a,function(a){return a[b]==c});_.verifyCallback(e)(d)})}function m(a,c,d,e){d=_.verifyCallback(d),e=_.verifyCallback(e),b(a).then(function(a){a.batch(c,function(){d()},function(a){e(a)})})}var n=[];return _.delay(a,15e3),{getStore:b,get:c,getAll:d,print:e,add:f,update:g,remove:h,clear:i,batch:m,search:j,getAllByKey:k,getItemByKey:l,autoClearTask:a}}(),spotsManager=function(){function a(a){c={favorites:{enabled:!0,searchable:!0,id:"ef974b5a-432f-472b-89c6-c92a67d60182",location:"favorites",background_scripts:["favorites_service.js","topsites_service.js","bookmarks_service.js","chrome_apps_service.js","recent_sites_service.js"],name:"favorites",display_name:"Favorites",sync:!0,newtab:{enabled:!0,show_clock:!0,position:"spots_menu",controllers:["FavoritesNewtabCtrl.js","NewtabFavoritesSearchResultCtrl.js","FavoritesAddModalCtrl.js","FavoritesEditModalCtrl.js","FavoritesDeleteModalCtrl.js","FavoritesCategoriesAddModalCtrl.js","FavoritesCategoriesEditModalCtrl.js","FavoritesCategoriesDeleteModalCtrl.js","FavoritesRemoveTopSitesModalCtrl.js"],directives:["favorites.html"],css:["NewtabFavoritesSearchResult.css","FavoritesNewtab.css"],search_result_partial:"NewtabFavoritesSearchResult.html"},opentab:{enabled:!0,color:"#F1A30B",search_result_partial:"OpentabFavoritesSearchResult.html",css:["OpentabFavoritesSearchResult.css","favorites_opentab.css"]}},contacts:{enabled:!0,searchable:!0,id:"f46a7851-c2d9-4476-921c-cb5d9cf7bdaf",location:"phone",name:"contacts",display_name:"Contacts",background_scripts:["contacts_service.js"],sync:!0,newtab:{enabled:!0,controllers:["NewtabContactsSearchResultCtrl.js"],css:["NewtabContactsSearchResult.css"],search_result_partial:"NewtabContactsSearchResult.html"},idbIndexes:[{name:"id",keyPath:"id",unique:!0,multiEntry:!1}],opentab:{enabled:!0,search_result_partial:"OpentabContactSearchResult.html",css:["OpentabContactSearchResult.css"]},clear_on_logout:!0},call_log:{enabled:!0,id:"3858d2ce-b236-4071-864f-456830940106",location:"phone",background_scripts:["call_log_service.js"],name:"call_log",display_name:"Call Log",sync:!0,newtab:{enabled:!1,notification_partial:"call_log_newtab_notification.html"},idbIndexes:[{name:"timestamp",keyPath:"timestamp",unique:!1,multiEntry:!0},{name:"from",keyPath:"from",unique:!1,multiEntry:!0}],opentab:{notification_partial:"call_log_opentab_notification.html"},clear_on_logout:!0},sms:{enabled:!0,searchable:!0,id:"8f3aa049-b0ec-4344-a958-0c703200bce4",location:"phone",background_scripts:["sms_service.js"],name:"sms",display_name:"SMS",sync:!0,newtab:{enabled:!1,notification_partial:"sms_newtab_notification.html"},idbIndexes:[{name:"timestamp",keyPath:"timestamp",unique:!1,multiEntry:!0},{name:"from",keyPath:"from",unique:!1,multiEntry:!0},{name:"number",keyPath:"number",unique:!1,multiEntry:!0},{name:"type",keyPath:"type",unique:!1,multiEntry:!0}],opentab:{notification_partial:"sms_opentab_notification.html"},clear_on_logout:!0},phone:{enabled:!0,id:"phone",location:"phone",name:"phone",display_name:"Phone",background_scripts:["phone_notification.js"],sync:!1,icon:"icon-phone.png",opentab:{enabled:!0,color:"#BF1E4B",main_view:"phone_opentab.html"},clear_on_logout:!0},discovery:{enabled:!0,id:"78e57c52-fac7-5910-74fc-5051064f6354",location:"discovery",name:"discovery",display_name:"Discovery",sync:!1,icon:"icon-discovery.png",background_scripts:["discovery_service.js","outbrain_feed.js","facebook_feed.js"],newtab:{enabled:!0,controllers:["NewtabDiscoveryCtrl.js","DisableDiscoveryModalCtrl.js","DiscoveryAddFacebookModalCtrl.js","DiscoveryAddFacebookNotificationCtrl.js"],css:["NewtabDiscovery.css","DiscoveryAddFacebookModal.css"],notification_partial:"DiscoveryAddFacebookNotification.html",modal_partials:{createSpotsAccount:"modals/CreateSpotsAccountModal.html",discoveryAddFacebook:"modals/DiscoveryAddFacebookModal.html"}}},apps:{enabled:!0,id:"185ecf76-f51f-4477-82eb-4c3e0dc65b94",location:"apps",name:"apps",background_scripts:["apps_service.js","apps_grabber_service.js"],display_name:"Apps",sync:!0,opentab:{enabled:!0,css:["apps_opentab.css"]},clear_on_logout:!0},facebook:{enabled:!0,searchable:!1,id:"ef974b5a-432f-472b-89c6-c92a67d60188",location:"facebook",background_scripts:["facebook_service.js"],name:"facebook",display_name:"facebook",sync:!1,newtab:{enabled:!0,notification_partial:"facebook_newtab_notification.html",controllers:["FacebookRateUsModalCtrl.js"],css:["FacebookRateUsModal.css"],modal_partials:{facebookRateUs:"modals/FacebookRateUsModal.html"}},opentab:{notification_partial:"facebook_opentab_notification.html"}},gallery:{enabled:!0,searchable:!0,id:"gallery",location:"gallery",background_scripts:["gallery_service.js"],name:"gallery",display_name:"Gallery",sync:!1,newtab:{enabled:!1}},review:{enabled:!0,id:"review",location:"review",name:"review",display_name:"Review",sync:!1,newtab:{enabled:!0,controllers:["NewtabReviewCtrl.js"],directives:["NewtabReview.html"],css:["NewtabReview.css"]}},search:{enabled:!0,id:"7e0f48f9-9501-41ec-8aee-8cb067451a6a",location:"search",name:"search",display_name:"Search",sync:!1,background_scripts:["search_service.js","web_search_service.js"],newtab:{enabled:!0,controllers:["SearchCtrl.js","NewtabSearchResultCtrl.js"],directives:["search.html"],css:["NewtabSearchResult.css"],search_result_partial:"NewtabSearchResult.html"},opentab:{enabled:!0,color:"#1BA0E1",main_view:"search_opentab.html",search_result_partial:"OpentabSearchResult.html",css:["OpentabSearchResult.css","search_opentab.css"]}},weather:{enabled:!0,id:"412ee6f2-5147-5fc7-4039-708c156dc63d",location:"weather",name:"weather",display_name:"Weather",sync:!1,icon:"icon-weather.png",background_scripts:["weather_service.js"],newtab:{enabled:!0,controllers:["NewtabWeatherCtrl.js","NewtabClockCtrl.js"],css:["NewtabWeather.css"],notification_widgets:[{name:"Clock",priority:100,partial:"NewtabClock.html",icon:"images/clock-icon-small.png"},{name:"Weather",priority:200,partial:"NewtabWeather.html",icon:"images/cloud-icon-small.png"}]},opentab:{enabled:!1,notification_widgets:[{name:"Clock",priority:100,partial:"OpentabClock.html",icon:"images/clock-icon-small-black.png"},{name:"Weather",priority:200,partial:"OpentabWeather.html",icon:"images/cloud-icon-small-black.png"}]}}},a(c)}function b(a){return c||d.success(a)}var c=null,d=$.Deferred();return{init:function(b,c){a(function(a){d.resolve(a),b&&b(a)},c)},getSpots:b,getSpotsArray:function(){return _.toArray(c)},getSpotByID:function(a){return _.find(c,{id:a})},spotID:function(a){return c[a].id},getSpot:function(a){return c[a]}}}(),spotsAPI=function(){function a(a,b){u=!1,r=!1,idb.clear("SPOTS_DATA",function(){idb.clear("SERVER_QUEUE",function(){j(null,a,b)})})}function b(b,c,d,e){return _.extend(n,{token:config.token,uuid:config.uuid,guid:config.guid}),n.token?void $.ajax(config.url_api+"/"+b,{headers:n,dataType:"json",data:{data:c?JSON.stringify(c):""},type:"POST",complete:function(b){var c;try{c=JSON.parse(b.responseText)}catch(f){c=b.responseText}switch(b.status){case 200:_.verifyCallback(d)(c);break;case 400:_gaq.push(["_trackEvent","spotsAPI","Error",400]),console.error("%c spotsAPI :: 400 Error with POST, something is wrong with the request, getting last good condition..",p),console.error("%c spotsAPI :: %s",b.responseText,p),a(null,e);break;case 409:_gaq.push(["_trackEvent","spotsAPI","Error",409]),a(null,e);break;case 401:_gaq.push(["_trackEvent","spotsAPI","Error",401]),user.logout(),eventManager.dispatchEvent("CONFIG","USER_TOKEN_EXPIRED",null);break;case 500:case 502:case 666:default:_gaq.push(["_trackEvent","spotsAPI","Error",b.status]),console.error("%c spotsAPI :: POST Error :: Status: "+b.status+" Response: "+b.responseText,p),_.verifyCallback(e)(c)}}}):void _.verifyCallback(e)()}function c(b,c,d,e){return _.extend(n,{token:config.token,uuid:config.uuid,guid:config.guid}),n.token?void $.ajax(config.url_api+"/"+b,{headers:n,dataType:"json",data:{data:c?JSON.stringify(c):""},type:"GET",complete:function(b){var c;try{c=JSON.parse(b.responseText)}catch(f){c=b.responseText}switch(b.status){case 200:_.verifyCallback(d)(c);break;case 401:user.logout(),eventManager.dispatchEvent("CONFIG","USER_TOKEN_EXPIRED",null),_.verifyCallback(e)();break;case 409:_gaq.push(["_trackEvent","spotsAPI","Error",409]),console.error("%c spotsAPI :: GET 409 Error :: Status: "+b.status+" Response: "+b.responseText,p),a(d,e);break;case 500:case 502:case 666:default:_gaq.push(["_trackEvent","spotsAPI","Error",b.status]),console.error("%c spotsAPI :: GET Error :: Status: "+b.status+" Response: "+b.responseText,p),_.verifyCallback(e)(c)}}}):void _.verifyCallback(e)()}function d(a,b,c,d,e){var f=spotsManager.getSpotByID(a);if(f&&f.sync){var g={id:"rq_"+Date.now(),timestamp:Date.now(),spot_id:a,object_id:b,type:c};"delete"!=c&&(g.object_data=d),idb.add("SERVER_QUEUE",g,function(a){q(),_.verifyCallback(e)(a)},!1)}else console.error("%c spotsAPI :: queue was called for an un-synced object"+a+" "+b+" "+c+" "+d,o),_.verifyCallback(e)(!0)}function e(a,c){if(r)s.push({success:a,error:c});else{if(r=!0,!n.token)return void g();idb.getAll("SERVER_QUEUE",function(d){idb.getAll("SPOTS_DATA",function(e){var h={};m=[],_.each(d,function(a){m.push(a.id);var b=_.find(h,{spot_id:a.spot_id,object_id:a.object_id,type:a.type});b?b.timestamp<a.timestamp&&(h[b.object_id]=null,h[a.object_id]=a):h[a.object_id]=a});var j={};_.each(h,function(a){j[a.spot_id]||(j[a.spot_id]={},j[a.spot_id].spot_id=a.spot_id,j[a.spot_id].sequences=[{}],j[a.spot_id].sequences[0].sequence=e[a.spot_id]?parseInt(e[a.spot_id].sequence)+1:1,j[a.spot_id].sequences[0].sequence_data=[]),j[a.spot_id].sequences[0].sequence_data.push({object_id:a.object_id,type:a.type,object_data:k(a.object_data)})});var l=[];return _.each(j,function(a){l.push(a)}),l.length<1?(_.verifyCallback(a)(),void g()):void b("spot",l,function(){var b={};_.each(l,function(a){_.each(a.sequences,function(c){(!b[a.spot_id]||b[a.spot_id].value.sequence<c.sequence)&&(b[a.spot_id]={spot_id:a.spot_id,sequence:c.sequence})})}),async.each(_.toArray(b),function(a,b){i(a.spot_id,a.sequence,b)},function(){f(function(){g(),_.verifyCallback(a)()})})},function(){g(),_.verifyCallback(c)()})})})}}function f(a){var b=_.map(m,function(a){return{type:"remove",key:a}});idb.batch("SERVER_QUEUE",b,a,a)}function g(){if(r=!1,s.length>0){var a=s.pop();e(a.success,a.error)}}function h(a,b,c){idb.get("SPOTS_DATA",a,function(d){d?_.verifyCallback(b)(d.sequence):c&&i(a,0,function(){h(a,b,c)},c)})}function i(a,b,c,d){idb.update("SPOTS_DATA",{id:a,sequence:b},function(a){a?_.verifyCallback(c)(a):d&&_.verifyCallback(d)(a)},!1)}function j(a,b,d){u?t.push({spotsList:a,success:b,error:d}):(u=!0,idb.getAll("SPOTS_DATA",function(e){var f=[],g={};_.each(spotsManager.getSpotsArray(),function(b){var c={spot_id:b.id,sequence:0};e[b.id]&&e[b.id].sequence&&(c.sequence=parseInt(e[b.id].sequence)),b.sync&&(!a||_.isArray(a)&&0==a.length?f.push(c):a&&_.indexOf(a,b.id)>-1&&f.push(c)),g[c.spot_id]=c.sequence}),c("spot",f,function(a){var c,e,f,g,h=0,i=[];async.eachSeries(a,function(a,b){f=a.spot_id,g=spotsManager.getSpotByID(f).display_name,a.snapshot&&_.size(a.snapshot)>0?(c=[],_.each(a.snapshot,function(a,b){try{a=l(a),a.id=b,c.push({type:"put",value:a})}catch(d){console.warn("Problem with data, skipping."),console.warn("spotID: %s, objectID: %s, data: %s",f,b,a)}}),c.length>0?idb.clear(f,function(){idb.batch(f,c,function(){spotsAPI.setSequence(f,parseInt(a.sequence),function(){h+=c.length,i.push(f),b(null)})},function(){spotsAPI.setSequence(f,0,function(){console.warn("%s Batch error!",g,c),b(f)})})}):(console.warn("  !! Batch array is empty !!"),b(null))):a.sequences&&_.size(a.sequences)>0?(c=[],_.each(a.sequences,function(a){e=a.sequence,_.each(a.sequence_data,function(a){try{switch(a.object_data=l(a.object_data),a.object_data.id=a.object_id,a.type){case"add":case"update":c.push({type:"put",value:a.object_data});break;case"remove":c.push({type:"remove",value:a.object_data})}}catch(b){console.warn("Problem with data, skipping."),console.error("spotID: %s, objectID: %s, data: %s",f,a.object_id,a.object_data)
}})}),c.length>0?idb.batch(f,c,function(){spotsAPI.setSequence(f,parseInt(e),function(){h+=c.length,i.push(f),b(null)})},function(a){console.error(a),console.error("%s Batch error!",f,c),b(f)}):spotsAPI.setSequence(f,parseInt(e),function(){h+=c.length,i.push(f),b(null)})):b(null)},function(c){if(_.each(i,function(b){eventManager.dispatchEvent(b,"UPDATE_EVENT",a)}),u=!1,t.length>0){var e=t.pop();j(e.spotsList,e.success,e.error)}c?(console.error("Update errors!",c),console.error("The following spots could not be updated!",c),_.verifyCallback(d)()):_.verifyCallback(b)()})},function(){u=!1})}))}function k(a){if(a){var b=XbvYseDOoT.enc.Utf8.parse(XbvYseDOoT.NqharXMLHB(config.guid+config.jGmhAKOXuv).toString().substr(16)),c=XbvYseDOoT.enc.Utf8.parse(XbvYseDOoT.NqharXMLHB(config.jGmhAKOXuv+config.guid).toString().substr(0,16));a=JSON.stringify(a),a=XbvYseDOoT.jPqgVfWIor.encrypt(a,b,{iv:c}).toString()}return a}function l(a){if(a){a=a.replace(/\s/g,"+");var b=XbvYseDOoT.enc.Utf8.parse(XbvYseDOoT.NqharXMLHB(config.guid+config.jGmhAKOXuv).toString().substr(16)),c=XbvYseDOoT.enc.Utf8.parse(XbvYseDOoT.NqharXMLHB(config.jGmhAKOXuv+config.guid).toString().substr(0,16));a=XbvYseDOoT.jPqgVfWIor.decrypt(a,b,{iv:c}).toString(XbvYseDOoT.enc.Utf8),a=JSON.parse(a)}return a}var m,n={ct:"ch",cv:window.navigator.appVersion.match(/Chrome\/(.*?) /)[1],res:screen.width+"x"+screen.height,v:config["spots.version"],c:""},o="background:#F5EAFA;",p="background:#E5CAF2;",q=_.debounce(e,config.api_autoPostTimer),r=!1,s=[],t=[],u=!1;return{POST:b,GET:c,queue:d,postQueue:e,getSequence:h,setSequence:i,clearAndRequestUpdate:a,requestUpdate:j,encrypt:k,decrypt:l}}(),eventManager=function(){function a(a){a=_.verifyCallback(a),_.delay(c.bind(null,!0),config.cleanupEventListenersInterval),chromeEvents.onTabRemoved(function(a){eventManager.removeTabEvents(a)}),_.each([chromeEvents.onTabLoading,chromeEvents.onTabCompleted],function(a){a(function(a,b){b.url&&eventManager.removeTabEvents(a)})}),a()}function b(a,b){k[a]={$broadcast:b}}function c(a){var b=_.chain(j).pluck("tabID").unique().compact().value();chrome.tabs.query({},function(d){var e=_.pluck(d,"id"),f=_.difference(b,e);_(f).forEach(eventManager.removeTabEvents),a&&_.delay(c.bind(null,!0),config.cleanupEventListenersInterval)})}function d(a,b,c,d){_.each(j,function(d){if(d&&a==d.spot&&b==d.eventType&&d.eventHandler)try{d.eventHandler(c)}catch(e){console.warn("eventManger :: error dispatchEvent %s, %s, %o",d.spot,d.eventType,e),_gaq.push(["_trackEvent","Error","EventManager",e.toString()]),"TypeError"==e.name&&g(d.spot,d.eventType,d.eventHandler)}}),_.each(k,function(d){d.$broadcast(a+"_"+b,c)}),opentab.dispatchEvent(a,b,c,d)}function e(a,b,c,d,e){j.push({spot:a,eventType:b,eventHandler:c,scope:d,tabID:e}),d&&d.$on("$destroy",function(){g(a,b,c)})}function f(a){j=_.reject(j,function(b){return b.tabID==a}),k[a]&&delete k[a]}function g(a,b,c){_.each(j,function(d,e){d&&a==d.spot&&b==d.eventType&&c==d.eventHandler&&j.splice(e,1)})}function h(){return j}function i(){return k}var j=[],k={};return{init:a,cleanupEventListeners:c,dispatchEvent:d,addEventListener:e,removeEventListener:g,getListenerList:h,getScopeList:i,removeTabEvents:f,addScope:b}}(),languageManager=function(){"use strict";function a(a){a=_.verifyCallback(a),j=b(),c(j,a)}function b(){if(config.selectedLanguage&&""!=config.selectedLanguage)return _gaq.push(["_trackEvent","Languages",config.selectedLanguage,"Selected"]),config.selectedLanguage;if(window.navigator.language){var a=window.navigator.language.substr(0,2);return-1!=config.languagesOptions.indexOf(a)?(_gaq.push(["_trackEvent","Languages",a,"Default"]),a):(_gaq.push(["_trackEvent","Languages",k,"Default-Not-In-Index"]),k)}return _gaq.push(["_trackEvent","Languages",k,"Default-Navigator-Not-Set"]),k}function c(a,b){b=_.verifyCallback(b),d(a,function(c){"en"!=a?d("en",function(a){l=_.extend({},a,c),b()}):(l=c,b())})}function d(a,b){b=_.verifyCallback(b),$.ajax("/locales/i18n_"+a+".json",{dataType:"text",type:"GET",success:function(a){try{var c=JSON.parse(a);b(c)}catch(d){console.error("loadLanguage error:",d)}},error:function(a){console.error("loadLanguage Error",a)}})}function e(){a(function(){eventManager.dispatchEvent("SETTINGS","LANGUAGE_CHANGED",{obg:l,langName:j})})}function f(){return l}function g(){return j}function h(a){return l[a]?l[a]:""}function i(a,b){l[a]=b}var j,k="en",l={};return{init:a,changeLang:e,getLangObj:f,getLang:g,getSelectedLang:b,getTranslation:h,setTranslation:i}}(),pushService=function(){function a(){c=new EventSource(config.url_pushServer+config.guid),c.addEventListener("open",function(){}),c.addEventListener("error",function(a){console.error("%c pushService :: error: %o","background:#E2F0B6;",a)}),c.addEventListener("message",function(a){var b=JSON.parse(a.data),c=JSON.parse(b.message.default);config.uuid!==c.uuid&&("1"==c.type?(e=_.union(e,c.data),d&&(clearTimeout(d),delete d),d=setTimeout(function(){spotsAPI.requestUpdate(e,function(){d&&(clearTimeout(d),delete d,e=[])})},1e3)):(c.data.data.event_data=spotsAPI.decrypt(c.data.data.event_data),eventManager.dispatchEvent(c.data.data.spot_id,c.data.data.event_type,c.data.data.event_data)))})}function b(a,b,c,d,e){function f(){configAPI.set("notification_api_sequence",config.notification_api_sequence+1)}configAPI.setDefault("notification_api_sequence",Math.round(parseInt((new Date).getTime())/1e5)),spotsAPI.POST("notify",{data:{spot_id:a,event_type:b,event_data:spotsAPI.encrypt(c)},sequence:config.notification_api_sequence},function(){f(),d&&d()},function(){f(),e()})}var c,d,e=[];return{init:function(){a()},destroy:function(){c=null},sendNotification:function(a,c,d,e,f){b(a,c,d,e,f)}}}(),notificationManager=function(){"use strict";function a(a){a=_.verifyCallback(a),_.each(spotsManager.getSpotsArray(),function(a){j[a.id]=a.newtab&&a.newtab.notification_partial?"/app/spots/"+a.location+"/newtab/partials/"+a.newtab.notification_partial:"/app/newtab/partials/notifications/DefaultNotification.html",k[a.id]=a.opentab&&a.opentab.notification_partial?"/spots/"+a.location+"/opentab/partials/"+a.opentab.notification_partial:"/newtab/opentab/notifications/DefaultNotification.html",a.newtab&&_.isArray(a.newtab.notification_widgets)&&_.each(a.newtab.notification_widgets,function(b){b.name&&b.partial&&(b.partial="/app/spots/"+a.location+"/newtab/partials/"+b.partial,b.icon&&(b.icon="/app/spots/"+a.location+"/"+b.icon),l.push(b))}),a.opentab&&_.isArray(a.opentab.notification_widgets)&&_.each(a.opentab.notification_widgets,function(b){b.name&&b.partial&&(b.partial="/"+a.location+"/opentab/partials/"+b.partial,b.icon&&(b.icon="/app/spots/"+a.location+"/"+b.icon),m.push(b))})}),notificationManager.getAll(null,function(b){var c=(new Date).getTime();_.each(b,function(a){a.expiration-c<0?e(a.id,null):_.delay(function(){e(a.id,null)},a.expiration-c)}),a()})}function b(a,b){b=_.verifyCallback(b),a&&a.spotID&&a.objectID&&a?(a.id=a.spotID+"_"+a.objectID,a.expiration||(a.expiration=(new Date).getTime()+864e5),_.isUndefined(a.priority)&&(a.priority=3),_.isUndefined(a.newtab)&&(a.newtab=!0),_.isUndefined(a.opentab)&&(a.opentab=!0),_.isUndefined(a.timestamp)&&(a.timestamp=(new Date).getTime()),a.expiration>(new Date).getTime()&&idb.add(i,a,function(){idb.get(a.spotID,a.objectID,function(c){a.data=c,eventManager.dispatchEvent("NOTIFICATIONS","NOTIFICATION_ADDED",a),a.toast&&(_.isUndefined(a.toast.priority)&&(a.toast.priority=a.priority-2),chrome.notifications.create(a.id,a.toast,function(){})),_.delay(function(){e(a.id,null)},a.expiration-(new Date).getTime()),b(a.id)})},!1)):console.error("Missing required fields while trying to set notification")}function c(a,b){b=_.verifyCallback(b),idb.get(i,a,function(a){a&&!a.data?idb.get(a.spotID,a.objectID,function(c){a.data=c,b(a)}):b(a)})}function d(a,b){b=_.verifyCallback(b),idb.getAll(i,function(c){c=a?_.where(c,a):_.toArray(c),async.each(c,function(a,b){a.data?b(null):idb.get(a.spotID,a.objectID,function(c){a.data=c,b(null)})},function(){b(c)})})}function e(a,b){b=_.verifyCallback(b),c(a,function(c){c?idb.remove(i,a,function(){eventManager.dispatchEvent("NOTIFICATIONS","NOTIFICATION_CLEARED",c),chrome.notifications.clear(a,function(){}),b()},!1):b()})}function f(a){(a=_.verifyCallback(a))(m)}function g(a){(a=_.verifyCallback(a))(k)}function h(a){a=_.verifyCallback(a),idb.clear(i,function(){eventManager.dispatchEvent("NOTIFICATIONS","ALL_NOTIFICATIONS_CLEARED",null),a()})}var i="NOTIFICATIONS",j={},k={},l=[],m=[];return chrome.notifications.onClosed.addListener(function(a,b){b&&e(a,null)}),{set:b,get:c,getAll:d,clear:e,clearAll:h,init:a,notificationPartials:j,getOpentabNotificationPartials:g,notificationWidgets:l,getOpentabNotificationWidgets:f}}(),user=function(){function a(){try{idb.clear("SERVER_QUEUE"),idb.clear("MAGIC_DATA"),idb.clear("NOTIFICATIONS"),notificationManager.clearAll(function(){}),_.each(spotsManager.getSpots(),function(a){spotsAPI.setSequence(a.id,0),a.clear_on_logout&&idb.clear(a.id,function(){eventManager.dispatchEvent(a.id,"UPDATE_EVENT",null)})}),configAPI.set("apps_spot_used",!1),pushService.destroy(),configAPI.set("guid",null),configAPI.set("token",null),configAPI.set("user",null),configAPI.set("loginDate",null),eventManager.dispatchEvent("CONFIG","USER_LOGOUT_SUCCESS"),_gaq.push(["_trackEvent","Logout",config.idp,"Success"])}catch(a){eventManager.dispatchEvent("CONFIG","USER_LOGOUT_ERROR"),_gaq.push(["_trackEvent","Logout",config.idp,"Error"])}}function b(){_gaq.push(["_trackEvent","User","Token-Renew","Called"]),spotsAPI.POST("auth/renew/",{},function(a){configAPI.set("user",a),configAPI.set("token",a.token),configAPI.set("guid",a.guid),configAPI.set("token_last_renew",(new Date).getTime()),_gaq.push(["_trackEvent","Login","Token-Renew","Success"])},function(){console.error("%c background :: --> Token Renew Failed","background:#dfdfdf;",config.guid),_gaq.push(["_trackEvent","Login","Token-Renew","Failed"])})}function c(){if(!f())return null;var a={givenName:config.user.givenName,familyName:config.user.familyName,display:[config.user.givenName,config.user.familyName].join(" "),phones:{}};return config.user.fbid?a.image="https://graph.facebook.com/"+config.user.fbid+"/picture":config.user.gpicture&&(a.image=config.user.gpicture),a}function d(){_.each(config.idb_tables,function(a){idb.clear(a)}),_.each(spotsManager.getSpots(),function(a){idb.clear(a.id)}),configAPI.restoreDefaults(),setTimeout(function(){chrome.runtime.reload()},3e3)}function e(){return config.userIsOrganic}function f(){return!!_.size(config.user)}function g(){function a(a){var b=[];return _.each(a,function(a,c){_.isString(a)&&b.push(c+": "+a)}),b.join("\n")}var b=[];async.eachSeries([function(c){var d={version:config.version,token:config.token,uuid:config.uuid,didLogin:config.didLogin,installedAndroidApp:config.installedAndroidApp,hasAndroidDevices:config.hasAndroidDevices,user:config.user,token_last_renew:config.token_last_renew,installationDate:config.installationDate,idp:config.idp};b.push(a(d)),c()},function(c){idb.getAll("SPOTS_DATA",function(d){var e={};_.each(d,function(a){var b=spotsManager.getSpotByID(a.id);b&&b.sync&&(e[b.name]=a.sequence)}),b.push(a(e)),c()})},function(){b.push(a(navigator))},function(a){chrome.tabs.captureVisibleTab(null,{},function(c){b.push(c),a()})}],function(){})}return{logout:a,tokenRenew:b,userContact:c,clearAll:d,isOrganic:e,isLoggedIn:f,hasAccount:f,getUserReport:g}}(),magicAPI=function(){function a(a){eventManager.addEventListener("NOTIFICATIONS","ALL_NOTIFICATIONS_CLEARED",e),f(),setInterval(h,864e5),a()}function b(a,b){u?v.push(a):b.apply(a)}function c(){if(u=!1,v.length>0){var a=v.pop();a.func.apply(null,a.args)}}function d(a,e,f){b({func:d,args:[a,e,f]},function(){u=!0,l(a,e,function(b){b&&b.notifications&&b.notifications[f]&&(delete b.notifications[f],_.isEmpty(b.notifications)&&delete b.notifications,o(b,function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a),c()}))})})}function e(){b({func:e,args:[]},function(){idb.search(t,function(a){return void 0!==a.notifications},function(a){var b=[];_.each(a,function(a){delete a.notifications,b.push({type:"put",value:a})}),_.size(b)>0?idb.batch(t,b,function(){c()},function(){console.error("An error occurred while trying to clean all notifications from magic."),c()}):c()})})}function f(){b({func:f,args:[]},function(){idb.search(t,function(a){return void 0!==a.notifications},function(a){var b=[];notificationManager.getAll(null,function(d){if(d){var e=_.values(a);_.each(e,function(a){var c=_.keys(a.notifications),e=!1;_.each(c,function(b){_.find(d,function(a){return a.id==b})||(delete a.notifications[b],0==_.size(a.notifications)&&delete a.notifications,e=!0)}),e&&b.push({type:"put",value:a})}),_.size(b)>0?idb.batch(t,b,function(){c()},function(){console.error("MagicAPI :: An error occurred while cleaning up notifications from magic."),c()}):c()}else c()})})})}function g(a,d,e){b({func:g,args:[a,d,e]},function(){l(a,d,function(b){b||(b=n(a,d,0)),b.notifications||(b.notifications={}),b.notifications[e]=(new Date).getTime(),o(b,function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a),c()})})})}function h(){idb.getAll(t,function(a){_.each(a,function(a){if(a.score){var b=a.score-1;0!=b||a.notifications?(a.score=b,idb.update(t,a,function(){},!1)):q(a.spotID,a.objectID)}})})}function i(a,b){var c={id:a,timestamp:parseInt(b,10)};idb.add(t,c,function(){},!1)}function j(a,b){idb.get(t,a,function(a){b(a?a.timestamp:0)})}function k(a,b){idb.search(t,function(b){return b.spotID==a},function(a){0==a.length&&(a={}),b(a)})}function l(a,b,c){var d=m(a,b);idb.get(t,d,function(a){c(a)})}function m(a,b){return a+"_"+b}function n(a,b,c){var d={id:m(a,b),spotID:a,objectID:b,score:c};return d}function o(a,b){b=_.verifyCallback(b),idb.add(t,a,function(){b()},!1)}function p(a,b){var c=[];_.each(b,function(a){c.push({type:"put",value:a})}),idb.batch(t,c,function(){eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a)},function(){console.error("An error occurred while trying to clean all notifications from magic."),eventManager.dispatchEvent("MAGIC","ITEM_UPDATED",a)})}function q(a,b){var c=m(a,b);idb.remove(t,c,function(){},!1)}function r(a,b){l(a,b,function(c){c||(c=n(a,b,0)),c.score++,idb.add(t,c,function(){},!1)})}function s(a){a=_.verifyCallback(a),idb.clear("MAGIC_DATA",function(){a()})}var t="MAGIC_DATA",u=!1,v=[];return{init:a,setItems:p,removeItem:q,getItem:l,getItems:k,cleanAll:s,incrementItemScore:r,getLastUpdateTimestamp:j,setLastUpdateTimestamp:i,handleNotification:g,clearNotification:d,createMagicItem:n,getObjectKey:m}}(),opentab=function(){function a(){chrome.runtime.onConnect.addListener(function(a){a.onMessage.addListener(function(b){if("spots"==a.name)if(b.tab=a.sender.tab,b.sync){var c=window[b.serviceName][b.functionName].apply(window[b.serviceName],b.args);a.postMessage({result:c,data:b})}else b.args.push(function(c){a.postMessage({result:c,data:b})}),window[b.serviceName][b.functionName].apply(window[b.serviceName],b.args)}),setInterval(function(){_.each(j,function(a){_.each(a,function(){"undefined"!=typeof a.expirationDate&&new Date(a.expirationDate).getTime()>(new Date).getTime()&&idb.remove("NOTIFICATIONS_DATA",a.id,null,!1)})})},18e6)}),idb.getAll("NOTIFICATIONS_DATA",function(a){_.each(a,function(a){g(a)})})}function b(a,b,c,d){var e={msgType:k.event,spot:a,eventType:b,data:null==c?null:c};f(e,d)}function c(a,b,c,d,e){var h={msgType:k.notification,spot:a,id:b,priority:c,data:d,expirationDate:e},i={spot:a,id:b,priority:c,data:d,expirationDate:e,isRemoved:!1};idb.add("NOTIFICATIONS_DATA",i,function(){g(i)},!1),f(h)}function d(a,c){var d={spot:a,id:c};idb.search("NOTIFICATIONS_DATA",function(b){return b.id==c&&b.spot==a},function(a){_.each(a,function(a){a.isRemoved=!0,idb.update("NOTIFICATIONS_DATA",a,function(){h(a)},!1)})}),b("OpentabNotifications",l.remove,d)}function e(a,c,d,e,f){var g={spot:a,id:c,priority:d,notificationData:e,expirationDate:f},i={spot:a,id:c,priority:d,data:g,expirationDate:f,isRemoved:!1};idb.update("NOTIFICATIONS_DATA",i,function(){h(i)},!1),_.isUndefined(j[a])&&(j[a]=[]),j[a].push(g),b("OpentabNotifications",l.update,g)}function f(a,b){chrome.windows.getAll({populate:!0},function(c){_.each(c,function(c){var d=_.filter(c.tabs,function(a){return 0===a.url.indexOf("http")});b&&(d=_.filter(d,function(a){return _.contains(b,a.id)})),_.each(d,function(b){chrome.tabs.sendMessage(b.id,a)})})})}function g(a){"undefined"==typeof j[a.spot]&&(j[a.spot]=[]),j[a.spot].push(a)}function h(a){_.each(j[a.spot],function(b,c){b.id==a.id&&(j[a.spot][c]=a)})}function i(a){return"undefined"!=typeof a?j[a]:j}var j={},k={event:"event",notification:"notification"},l={remove:"remove",update:"update"};return a(),{dispatchEvent:b,addNotification:c,removeNotification:d,updateNotification:e,getNotifications:i}}(),graphicAssets=function(){"use strict";function a(a,b){b=_.verifyCallback(b);var c;if(7==a.length)c=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(a);else{if(4!=a.length)return{r:0,g:0,b:0};c=/^#?([a-f\d])([a-f\d])([a-f\d])$/i.exec(a)}return c=c?{r:parseInt(c[1],16),g:parseInt(c[2],16),b:parseInt(c[3],16)}:null,b(c),c}function b(b,c,d){d=_.verifyCallback(d);var e=a(b,null);c>1&&(c/=100);var f="rgba("+e.r+","+e.g+","+e.b+","+c+")";return d(f),f}function c(a,b,c,d){d=_.verifyCallback(d);var e="#"+((1<<24)+(a<<16)+(b<<8)+c).toString(16).slice(1);return d(e),e}function d(b,d,e){e=_.verifyCallback(e),d=d?d:1;var f=a(b);return f.r=_.keepWithinRange(Math.round(f.r*d),0,255),f.g=_.keepWithinRange(Math.round(f.g*d),0,255),f.b=_.keepWithinRange(Math.round(f.b*d),0,255),b=c(f.r,f.g,f.b,null),e(b),b}function e(b,c){c=_.verifyCallback(c);var d,e;if("#ffffff"==b||"#fff"==b)e="#000000";else if("#000000"==b||"#000"==b)e="#ffffff";else{try{var f=a(b?b:"#ffffff");d=(299*f.r+587*f.g+114*f.b)/255e3}catch(g){d=1}e=d>=.9?"#000000":"#ffffff"}return c(e),e}function f(a,b){b=_.verifyCallback(b),a=urls.getHostName(a,!0),idb.getItemByKey("COLOR_PICKER_CACHE","url",a,function(c){if(c)b(c.data,a);else try{$.ajax({dataType:"json",type:"GET",cache:!1,timeout:15e3,url:config.color_picker_api,data:{url:"http://"+a},success:function(c){c?(c.p=_.uniq(c.p),"#ffffff"==c.c.toLowerCase()&&(c.c="#212121"),c.r&&c.s&&idb.add("COLOR_PICKER_CACHE",{url:a,data:c,added:(new Date).getTime(),expiration:(new Date).getTime()+(c.r?6048e5:108e5)},null,!1),b(c,a)):(console.warn("ColorPicker :: Error fetching color for domain %s",a),b())},error:function(){console.warn("ColorPicker :: Error fetching color for domain %s",a),b()}})}catch(d){console.warn("ColorPicker :: Error fetching color for domain %s",a),b()}})}function g(a){return"string"==typeof a?0===a.indexOf("data:"):!1}function h(a){return"[object Blob]"===Object.prototype.toString.call(a)}function i(a){return h(a)?a:g(a)?dataURLtoBlob(a):null}function j(a){var b=$.Deferred();if(a instanceof Image)b.resolve(a);else{var c=new Image;if(g(a))return c.src=a,b.resolve(c);var d=new FileReader;d.onload=function(a){c.src=a.target.result,b.resolve(c)},d.readAsDataURL(a)}return b}function k(a,b,c){return j(a).then(function(a){b=Number(b)||500,c=Number(c)||500;var d=document.createElement("canvas"),e=document.createElement("canvas"),f=1;return a.width>b?f=b/a.width:a.height>c&&(f=c/a.height),e.width=a.width,e.height=a.height,e.getContext("2d").drawImage(a,0,0),d.width=a.width*f,d.height=a.height*f,d.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,d.width,d.height),d.toDataURL()})}function l(a,b,c){var d=$.Deferred();if(!a)return d.reject();b=Number(b)||.92,b>1&&(b=1),0>b&&(b=0);var e=new Image;return e.src=(window.URL||window.webkitURL).createObjectURL(a),e.onload=function(){var a=document.createElement("canvas");a.width=e.width,a.height=e.height,a.getContext("2d").drawImage(e,0,0);var f=_.tryFor(5,function(b){a.toBlob(function(a){a.size>c?f(b-.1):d.resolve(a)},"image/jpeg",b)},d.reject);f(b)},d}function m(a){return _.isString(a)?spotsAPI.encrypt(a).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,""):getUUID()}function n(a,b,c){var d=$.Deferred();return a=i(a),a?(b=m(b),(window.requestFileSystem||window.webkitRequestFileSystem)(window.PERSISTENT,null,function(e){e.root.getDirectory(c,{create:!0},function(c){c.getFile(b,{create:!0},function(b){b.createWriter(function(c){c.onwriteend=d.resolve.bind(d,b.toURL()),c.onwritestart=d.notify,c.onwrite=d.notify,c.onerror=d.reject,c.write(a)},d.reject)},d.reject)},d.reject)})):d.reject(),d.promise()}var o=_.memoize(function(a){return $.Deferred(function(b){if("string"==typeof a)if(g(a))b.resolve(a);else{var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==c.readyState&&200==c.status&&0===c.response.type.indexOf("image/")){var a=new FileReader;a.onload=function(a){b.resolve(a.target.result)},a.readAsDataURL(c.response)}},c.open("GET",a),c.responseType="blob",c.send()}else b.resolve("data:image/png;base64,")})});return{hexToRgb:a,hexToRgba:b,rgbToHex:c,colorLuminance:d,contrastFilter:e,webColorPicker:f,resizeImage:k,lowerImageQuality:l,toDataURL:o,toBlob:i,saveImage:n,toImageElement:j,isDataURL:g}}.call(this),userVoice=function(){"use strict";function a(a){var b=config.guid?config.guid:(new Date).getTime(),c=config.userVoiceData;idb.getAll("SPOTS_DATA",function(d){var e=[];_.each(d,function(a){var b=spotsManager.getSpotByID(a.id);b&&b.sync&&e.push(spotsManager.getSpotByID(a.id).name+"-"+a.sequence)});var f=e.join("|"),g={version:config.version,token:config.token,uuid:config.uuid,didLogin:config.didLogin,installedAndroidApp:config.installedAndroidApp,hasAndroidDevices:config.hasAndroidDevices,userSize:_.size(config.user),token_last_renew:config.token_last_renew,installationDate:config.installationDate,idp:config.idp,sequences:f};g=JSON.stringify(g),g=spotsAPI.encrypt(g);var h={guid:b,data:g,forum:c.forum,sid:c.sid};a(h)})}return{getCustomParams:a}}(),remoteScripts=function(){function a(a){b(),setInterval(function(){b()},config.remoteScriptsInterval),_.verifyCallback(a)()}function b(){config.remoteScripts&&(_.isArray(config.remoteScripts)?_.each(config.remoteScripts,c):_.isString(config.remoteScripts)?c(config.remoteScripts):analytics.reportError("remoteScripts",2,"Unknown variable type",null))}function c(a){a+="?cb="+(new Date).getTime(),$.getScript(a).done(function(){}).fail(function(){analytics.reportError("remoteScripts",3,"Remote script load failed",a)})}return{init:a,loadScripts:b}}(),init=function(){var a=["configAPI","analytics","chromeEvents","spotsManager","modalManager","eventManager","notificationManager","magicAPI","ftueAPI","patchHelper","languageManager","remoteScripts"];async.eachSeries(a,function(a,b){time.start("init-"+a),window[a].init(function(){time.end("init-"+a),b()})},initSpotData)},initSpotData=function(){idb.getAll("SPOTS_DATA",function(a){$.isEmptyObject(a)?async.map(spotsManager.getSpotsArray(),function(a,b){idb.add("SPOTS_DATA",{id:a.id,sequence:0},function(){b(null)},!1)},function(){initUser(!0)}):initUser(!0)})},initUser=function(a,b){b=_.verifyCallback(b),config.token?0!==_.size(config.user)&&config.user.guid&&config.user.token?(pullUpdates(a),b(config.user)):spotsAPI.GET("user",null,function(c){configAPI.set("user",c),configAPI.set("token",c.token),configAPI.set("guid",c.guid),pullUpdates(a),b(config.user)},function(){a&&getReferralSource(),b(!1)}):(configAPI.remove("user"),configAPI.remove("guid"),a&&(getReferralSource(),b(!1)))},pullUpdates=function(a){spotsAPI.requestUpdate(null,function(){spotsAPI.postQueue(function(){},function(){console.error("%c background :: --> pushUpdates error","background:#dfdfdf;")})},function(){console.error("%c background :: --> pullUpdates Error","background:#dfdfdf;")}),initPushService(a)},initPushService=function(a){pushService.init(),userTokenRenew(a)},userTokenRenew=function(a){configAPI.setDefault("token_last_renew",0);var b=config.token_valid_time/config.token_renew_attempts,c=config.token_valid_time-((new Date).getTime()-config.token_last_renew);b>c&&user.tokenRenew(),setTimeout(function(){user.tokenRenew(),userTokenRenew()},b),a&&getReferralSource()},getReferralSource=function(){config.referredBy||chrome.tabs.query({url:"<all_urls>"},function(a){var b=_.find(a,function(a){return a.url&&"spots"==urls.urlParameter(a.url.toLowerCase(),"p")&&urls.urlParameter(a.url.toLowerCase(),"r")});b?(b=urls.urlParameter(b.url.toLowerCase(),"r"),configAPI.set("referredBy",b)):(b="none",configAPI.set("referredBy",b)),_gaq.push(["_trackEvent","New User","Referral",b])}),getInstallationDate()},getInstallationDate=function(){config.installationDate?loadSpotsBackgroundScripts():utilsAPI.getCurrentTimeStamp(function(a){a&&configAPI.set("installationDate",a),loadSpotsBackgroundScripts()})},loadSpotsBackgroundScripts=function(){window.appGrabAPI=function(){function a(a){a=_.verifyCallback(a),config.module_import_list.push("appGrabAPI"),idb.getAll("HIDDEN_APPS",function(a){_.each(a,function(a){l.push(a)})}),k.push("play.google.com"),idb.getAll("DOMAIN_BLACK_LIST",function(a){_.each(a,function(a){k.push(a)})}),a()}function b(a,b){b=_.verifyCallback(b);var c=[],e=d(a);_.each(l,function(a){a.appDomain==e&&c.push(a.id)}),b(c)}function c(a,b,c){c=_.verifyCallback(c);var e=d(b),f={appDomain:e,id:a,timestamp:(new Date).getTime()};idb.add("HIDDEN_APPS",f,function(){l.push(f),c()})}function d(a){return a.replace(m,"").replace(n,"")}function e(a,b){b=_.verifyCallback(b);var c="http://en.api.hoolapp.com/query.php?type=apps&items=%s&items_key=2".replace(/\%s/,a.join(","));$.getJSON(c,function(c){f(c,b),g(a,c)})}function f(a,b){idb.getAll("185ecf76-f51f-4477-82eb-4c3e0dc65b94",function(c){var d=c,e=[];_.each(a,function(a){0!==Number(a.price)||_.findWhere(d,{"package":a.id})||e.push({id:a.id,name:a.name,description:utilsAPI.stripHtml(a.description),rating:a.rating,image:a.icon+"=w50",price:a.price,developer:a.developer,updatedDate:a.updatedDate,categories:a.category})}),b(e)})}function g(a,b){var c=[];_.each(a,function(a){_.findWhere(b,{id:a})||c.push(a)});var d="http://api.hoolapp.com/command.php?type=addapp&items="+c.join(",");$.getJSON(d,function(){})}function h(a,b){b=_.verifyCallback(b);var c=[],d=/(?:market\.android\.com\/details|play\.google\.com\/store\/apps\/details|\/store\/apps\/details)\?id\=(.+?)(?:\&|$)/;_.each(a,function(a){var b=d.exec(a);b&&-1===c.indexOf(b[1])&&c.push(b[1])}),b(c)}function i(a,b){b=_.verifyCallback(b);var c=d(a),e=!1,f=a.replace(m,"");_.each(k,function(a){(a==c||a==f)&&(e=!0)}),b(e)}function j(a,b,c){c=_.verifyCallback(c);var d;d=b?a.replace(m,"").replace(n,""):a.replace(m,""),idb.add("DOMAIN_BLACK_LIST",{id:d},function(){k.push(d),c()})}var k=[],l=[],m=new RegExp("http(s)?://(www.)?"),n=new RegExp("[/|?|#](.*)");return a(),{init:a,addAppToHiddenAps:c,getAppDetails:e,getHiddenApps:b,findAppsInLinks:h,isOnBlackList:i,addToBlackList:j}}(),window.apps=function(){"use strict";function a(){c()}function b(a){var b=_.filter(a,function(a){return a.spot_id==i&&(a.snapshot||a.sequences.length>0)});if(b.length>0){var e=[],f=[];_.each(a,function(a){a.sequences?_.each(a.sequences,function(a){_.each(a.sequence_data,function(a){if("add"==a.type){var b=a.object_data.package;j[b]=a.object_data,e.push(b)}else if("delete"==a.type){var c=_.findWhere(j,{id:a.object_id});c?f.push(c.package):console.error("Could not notify about app deletion since the app id %s wasn't found in cache",a.object_id)}})}):a.snapshot&&c()}),e.length>0&&d(e.join()),f.length>0&&eventManager.dispatchEvent(i,"APPS_EVENT",{type:"delete",apps:f})}}function c(){j={},idb.getAll(i,function(a){var b=[];_.each(a,function(a){var c=a.package;j[c]=a,a.details?configAPI.set("apps_spot_used",!0):b.push(c)}),b.length>0&&d(b.join())})}function d(a){var b=[];$.getJSON(configAPI.get("url_hoolapp"),{type:"apps",items_key:2,output_key:2,items:a},function(a){_.each(a,function(a,c){var d=j[c];d&&(d.details=a,g(d)&&(b.push(d),idb.update(i,d,null,!1)))}),b.length>0&&(configAPI.set("apps_spot_used",!0),eventManager.dispatchEvent(i,"APPS_EVENT",{type:"add",apps:b}))})}function e(a,b){idb.get(i,a,function(a){b(a)})}function f(a){idb.getAll(i,function(b){a(b)})}function g(a){return void 0!==a.details&&void 0!==a.details.icon&&void 0!==a.details.title}function h(a){var b=_.filter(j,function(a){return g(a)});a(b)}config.module_import_list.push("apps");var i=spotsManager.spotID("apps"),j={};return a(),eventManager.addEventListener(i,"UPDATE_EVENT",b),{getObject:function(a,b){e(a,b)},getAllObjects:function(a){f(a)},getAllObjectsArray:function(a){f(function(b){a(_.toArray(b))})},getApps:function(a){h(a)}}}(),window.discovery=function(){"use strict";function a(a){return _.find(j.providers,{name:a})}function b(b){var c=[],d=[],e={};_.each(j.providers,function(f){var i=a(f.name),k=_.groupBy(b[f.name],function(a){return a.provider=f.name,g[a.id]||h[a.source]?"blacklisted":a.paid?"paid":"unpaid"});k.blacklisted&&console.warn(k.blacklisted);var l=_.first(k.paid,i.maxPaidItems),m=Math.round(i.percentage*j.maxItems)-l.length;c=c.concat(l),d=d.concat(_.first(k.unpaid,m)),e[f.name]=_.rest(k.unpaid,m)});var f=_.first(c,j.maxPaidItems).concat(d);return f.length<j.maxItems&&_.each(j.providers,function(a){f=f.concat(e[a.name])}),_.first(f,j.maxItems)}function c(){var c=$.Deferred();return l.done(function(d){var e=_.pick(f,d),g=_.map(e,function(b){var c=a(b.name);return b.getFeed(c)});$.when.apply($,g).done(function(){var a=b(_.object(d,_.toArray(arguments)));_.isEmpty(a)?c.reject():c.resolve(a)})}),c.promise()}function d(a,b){switch(a){case"more":console.warn("lol not implemented"),b.id in i?delete i[b.id]:i[b.id]=b,configAPI.set("discoveryMoreLikeThisItems",i);break;case"less":g[b.id]=!0,configAPI.set("discoveryBlacklistedIDs",g),k();break;case"hide":h[b.source]=!0,configAPI.set("discoveryBlacklistedSources",h),k();break;case"report":}var c=f[b.provider];c&&_.isFunction(c.feedback)?c.feedback(a,b):console.warn(b.provider,"Feedback function not implemented")}var e=null,f={},g=configAPI.get("discoveryBlacklistedIDs")||{},h=configAPI.get("discoveryBlacklistedSources")||{},i=configAPI.get("discoveryMoreLikeThisItems")||{},j={maxItems:30,maxPaidItems:5,providers:[{name:"facebook",maxPaidItems:0,percentage:.5}]},k=_.whenOnline(function(){c().then(function(){e=this},function(){})}),l=$.Deferred(function(a){var b=_.pluck(j.providers,"name"),c=_.clone(b);a.progress(function(d){c=_.without(c,d),_.isEmpty(c)&&a.resolve(b)})}),m=_.cacheFor(12e5,k);return config.fbAccessToken||configAPI.set("enableContentDiscovery",!1),eventManager.addEventListener("CONFIG","USER_LOGIN_SUCCESS",function(){config.fbAccessToken&&configAPI.set("enableContentDiscovery",!0)}),eventManager.addEventListener("CONFIG","USER_LOGOUT_SUCCESS",function(){configAPI.set("enableContentDiscovery",!1)}),modalManager.add({name:"discoveryAddFacebook",once:!0,init:!(config.fbAccessToken||config.showDiscoveryAddFacebookNotification),when:moment(Number(utilsAPI.decrypt(config.installationDate))).add(7,"d"),onClose:function(){config.fbAccessToken||configAPI.set("showDiscoveryAddFacebookNotification",moment().add(7,"d").valueOf())}}),config.loginDate&&modalManager.add({name:"createSpotsAccount",once:!0,init:config.fbAccessToken&&config.loginDate&&!user.hasAccount(),when:moment(config.loginDate).add(7,"d")}),moment().isAfter(config.showDiscoveryAddFacebookNotification)&&(notificationManager.set({spotID:spotsManager.spotID("discovery"),objectID:"DISCOVERY_ADD_FACEBOOK_NOTIFICATION",newtab:!0,priority:0}),eventManager.addEventListener("CONFIG","USER_LOGIN_SUCCESS",function(){config.fbAccessToken&&notificationManager.getAll({objectID:"DISCOVERY_ADD_FACEBOOK_NOTIFICATION"},function(a){_.size(a)&&notificationManager.clear(_.first(a).id)})})),{feedback:d,getFeed:function(a){return e?e.then(a).done(m):c().then(function(){return e=this}).then(a).done(m)},addProvider:function(a){a&&a.name&&(f[a.name]=a,l.notify(a.name))},moreLikeThisItems:i}}(),function(){function a(a,b){switch(a){case"more":break;case"less":break;case"hide":e.push(b.originalItem.actor_id),configAPI.set("facebookProviderBlacklistedSources",e);break;
    case"report":}}function b(a,b,c){var d=a.attachment||{},e="profile_url"in b;return{id:"fb_"+a.post_id,paid:!1,url:d.href,originalUrl:null,source:b.name,icon:b.pic_square,title:d.name||d.caption||a.message,thumbnail:c,analyticsLabel:"Facebook-"+(e?"User":"Page"),originalItem:a}}function c(a){var b=!_.isString(a);return $.ajax({url:FQL_ENDPOINT_URL,data:{access_token:config.fbAccessToken,q:b?JSON.stringify(a):a},dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0}).then(function(a){if(b){var c={};return _.each(a.data,function(a){c[a.name]=a.fql_result_set}),c}return a.data})}function d(a){if(!config.fbAccessToken)return $.Deferred().resolve([]).promise();var d=["SELECT filter_key, message, attachment, permalink, actor_id, post_id FROM stream","WHERE filter_key in ('nf','pp')","AND created_time <= now()","AND type = 80","AND attachment.fb_object_id = ''",e.length?"AND NOT (actor_id IN ("+e.join(",")+"))":"","LIMIT "+(_.isNumber(a.maxItems)?2*a.maxItems:20)].join(" ");return c({posts:d,pages:"SELECT page_id, name, type, page_url, pic_square FROM page WHERE page_id in (SELECT actor_id FROM #posts)",users:"SELECT uid, name, profile_url, pic_square FROM user WHERE uid in (SELECT actor_id FROM #posts)"}).then(function(a){var d=_.indexBy(a.pages,"page_id"),e=_.indexBy(a.users,"uid"),f=_.unique(a.posts,"post_id");f=_.filter(f,function(a){var b=a.attachment.media[0],c=b&&0===(b.href||"").indexOf("https://www.facebook.com/events/"),d=b&&"link"===b.type&&b.src.indexOf("safe_image.php")>0;return d&&!c});var g=_.map(f,function(a){return"'"+a.attachment.media[0].src+"'"}).join(",");return c("SELECT source_url, url FROM link_image_src WHERE source_url in ("+g+") AND max_height = 600 AND max_width = 600").then(function(a){var c=_.indexBy(a,"source_url"),g=_.map(f,function(a){var f=d[a.actor_id]||e[a.actor_id]||{},g=a.attachment.media[0]?a.attachment.media[0].src:null;return b(a,f,(c[g]||{}).url)});return _.chain(g).unique("url").unique("title").value()})})}window.FQL_ENDPOINT_URL="https://graph.facebook.com/fql";var e=configAPI.get("facebookProviderBlacklistedSources")||[];discovery.addProvider({name:"facebook",feedback:a,getFeed:function(a){return $.Deferred(function(b){d(a).done(b.resolve).fail(function(){b.resolve([])})})}})}(),function(){function a(a){var b=a.source_display_name||a.source_name,c=!!a.pc_id;return{id:"ob_"+a.orig_url,paid:c,url:a.url,originalUrl:a.orig_url,source:isHTMLString(b)?$(b).filter(".ob_displayed_source, .ob_site_name").text():b,title:a.content,thumbnail:a.thumbnail&&a.thumbnail.url,analyticsLabel:"Outbrain-"+(c?"Paid":"Organic"),originalItem:a}}function b(){return $.ajax({url:"http://odb.outbrain.com/utils/get",data:{url:"http://spotsmagic.com/outbrain",widgetJSId:"AR_1",key:"SPOTS2014",user:user.guid,format:"vjnc"}}).then(function(b){return b=b.response,b&&0===b.status.id?_.map(b.documents&&b.documents.doc,a):[]})}window.isHTMLString=function(){var a=/^(?:\s*(<[\w\W]+>)[^>]*|#([\w-]*))$/;return function(b){return a.test(b)}}(),discovery.addProvider({name:"outbrain",getFeed:function(a){return $.Deferred(function(c){b(a).done(c.resolve).fail(function(){c.resolve([])})})}})}(),window.facebook=function(){"use strict";function a(a){a=_.verifyCallback(a),b(),eventManager.addEventListener("CONFIG","USER_LOGIN_SUCCESS",b),eventManager.addEventListener("CONFIG","USER_LOGOUT_SUCCESS",function(){configAPI.set("fbAccessToken",null)}),modalManager.add({name:"facebookRateUs",once:!0,when:moment(Number(utilsAPI.decrypt(config.installationDate))).add(user.isOrganic()?2:7,"d")}),a()}function b(){config.fbAccessToken&&(d(),g(3),c())}function c(){setInterval(function(){idb.getAll(m,function(a){_.each(a,function(a){a.expirationDate<(new Date).getTime()&&idb.remove(m,a.id,function(){},!1)})})},108e5)}function d(){f(e);var a=new Date((new Date).setDate((new Date).getDate()+1)),b=new Date(a.getFullYear(),a.getMonth(),a.getDate(),0,0,0,0)-new Date;setTimeout(function(){d()},b)}function e(a){_.each(a,function(a){idb.search(m,function(b){return b.id==a.uid},function(b){if(0===b.length){var c={id:a.uid,name:a.name,Date:new Date(a.birthday_date).getTime(),expirationDate:new Date((new Date).setDate(new Date(a.birthday_date).getDate()+1)).setHours(0,0,0,0),image:a.pic_square,firstName:a.first_name};idb.add(m,c,function(){notificationManager.set({spotID:m,type:"Facebook-Birthday",objectID:c.id,expiration:c.expirationDate,priority:2,newtab:!0,opentab:!0,toast:!1},null)},!1)}})})}function f(a){a=_.verifyCallback(a);var b="SELECT uid,name,pic_square,birthday_date,first_name FROM user WHERE(substr(birthday_date, 0, 2)="+((new Date).getMonth()+1)+")AND(substr(birthday_date, 3, 2)="+(new Date).getDate()+")AND uid IN(SELECT uid2 FROM friend WHERE uid1= me()) order by name",c=n+"fql?q="+b+"&access_token="+config.fbAccessToken;jQuery.ajax({url:c,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(b){a(b.data)}})}function g(a){h(a,i),setInterval(function(){h(a,i)},108e5)}function h(a,b){b=_.verifyCallback(b);var c=new Date,d=new Date((new Date).setDate((new Date).getDate()+a)),e=j(c),f=j(d),g="SELECT name,eid, pic_small,venue, location, start_time FROM event WHERE eid IN (SELECT eid FROM event_member WHERE uid =  me()) AND start_time >='"+e+"' AND start_time <='"+f+"'",h=n+"fql?q="+g+"&access_token="+config.fbAccessToken;jQuery.ajax({url:h,dataType:"json",xhrFields:{withCredentials:!0},crossDomain:!0,success:function(a){b(a.data)}})}function i(a){_.each(a,function(a){idb.search(m,function(b){return b.id==a.eid},function(b){if(0===b.length){var c={id:a.eid,name:a.name,Date:new Date(a.start_time).getTime(),location:a.location,expirationDate:(new Date).setDate(new Date(a.start_time).getDate()),image:a.pic_small};idb.add(m,c,function(){notificationManager.set({spotID:m,type:"Facebook-Event",objectID:c.id,expiration:c.expirationDate,priority:2,newtab:!0,opentab:!0,toast:!1},null)},!1)}})})}function j(a){Math.abs(a.getTimezoneOffset()/60).toString();return a.getUTCFullYear()+"-"+l(a.getUTCMonth()+1)+"-"+l(a.getUTCDate())+"T"+l(a.getUTCHours())+":"+l(a.getUTCMinutes())+":"+l(a.getUTCSeconds())+encodeURIComponent(k(a))}function k(a){var b=a.getTimezoneOffset()>0?"-":"+",c=Math.abs(a.getTimezoneOffset()),d=l(Math.floor(c/60)),e=l(c%60);return b+d+e}function l(a){return 10>a?"0"+a:a}config.module_import_list.push("facebook");var m=spotsManager.spotID("facebook"),n="https://graph.facebook.com/";return a(),{init:a,getTodaysBirthdays:f,setBirthdaysNotifications:d,getUpcomingEvents:h,clearExpiredItems:c}}(),window.bookmarks=function(){"use strict";function a(a,b,c){c({query:a,spotID:spotsManager.spotID("favorites"),type:"bookmarks",priority:200,results:b})}function b(b,c,d){d=_.verifyCallback(d),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"bookmarks")?chrome.bookmarks.search(b,function(e){e=_.first(e,c),a(b,e,d)}):a(b,[],d)}return{search:b}}(),window.chromeApps=function(){"use strict";function a(a){_.size(e)>0?a(e):chrome.management.getAll(function(b){e=[],_.each(b,function(a){a.enabled&&a.isApp&&(_.size(a.icons)>0&&(a.icon=a.icons[a.icons.length-1].url),e.push(a))}),a(e)})}function b(a,b,c){c({query:a,spotID:spotsManager.spotID("favorites"),type:"chrome-apps",priority:400,results:b})}function c(c,d,e){e=_.verifyCallback(e),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"chrome-apps")?a(function(a){var f=window.search.buildSearchRegex(c),g=_.filter(a,function(a){return f.test(a.name)||f.test(a.shortName)});g=_.first(g,d);var h=g.map(function(a){return graphicAssets.toDataURL(a.icon).then(function(b){return a.icon=b,a})});$.when.apply($,h).done(function(){b(c,g,e)})}):b(c,[],e)}function d(a){webappsUtils.launch(a)}config.module_import_list.push("chromeApps");{var e;_.memoize(function(a){return $.Deferred(function(b){if("string"==typeof a)if(0===a.indexOf("data"))b.resolve(a);else{var c=new XMLHttpRequest;c.onreadystatechange=function(){if(4==this.readyState&&200==this.status&&0===this.response.type.indexOf("image/")){var a=new FileReader;a.onload=function(a){b.resolve(a.target.result)},a.readAsDataURL(this.response)}},c.open("GET",a),c.responseType="blob",c.send()}else b.resolve("data:image/png;base64,")})})}return{getChromeApps:a,search:c,launchApp:d}}(),window.favorites=function(){"use strict";function a(){idb.getAll(v,function(a){a.DIRECTORY?(w=!1,u=a,eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"UPDATE",data:u},null),p()):c(function(a){u=a,eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"UPDATE",data:u},null)}),x.resolve(),_.each(a,function(a){b(a,!0)})})}function b(a,b){function c(b){b=_.unpick(b,"title","color","url"),_.isEmpty(b)||eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_UPDATED",data:_.extend(a,b)},null)}a&&a.url&&webScrapper.scrape(a.url,b).progress(c).done(c)}function c(a){gallery.getGallery(function(b){var c={DIRECTORY:{id:"DIRECTORY",directory:b.presets.directory}};_.each(c.DIRECTORY.directory,function(a){_.each(a.items,function(a){var d=b.items[a];c[a]={id:a,gallery_id:a,title:d.title,url:d.web&&d.web.urls&&d.web.urls["default"]?"http://"+String(d.web.urls["default"]).replace(/(http|https):\/\//,""):null,icon:d.assets.logo?d.assets.logo:null,color:d.assets.color}})}),a(c)})}function d(){var a=$.Deferred();return w?async.map(_.toArray(u),function(a,b){idb.add(v,a,b,!0)},function(){w=!1,a.resolve()}):a.resolve(),a.promise()}function e(a){return a=_.verifyCallback(a),x.promise().then(function(){a(u)})}function f(a,b){_.isObject(a)||(a={id:a}),e(function(c){var d=a.id?c[a.id]:_.find(c,function(b){return b.url==a.url||b.meta&&b.meta.redirectUrl==a.url});b(d||null)})}function g(a,b,c){c({query:a,spotID:v,type:"favorites",priority:800,results:b})}function h(a,b,c){if(c=_.verifyCallback(c),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"favorites")){var d=_.clone(u);delete d.DIRECTORY;var e=window.search.buildSearchRegex(a),f=_.filter(d,function(a){return e.test(a.title)||e.test(a.url)});f=_.first(f,b),g(a,f,c)}else g(a,[],c)}function i(a,c,e){if(e=_.verifyCallback(e),a=_.clone(a)){var f=0;if(c&&_.isNumber(c))f=c;else if(c&&_.isString(c)){var g=_.findWhere(u.DIRECTORY.directory,{id:c});f=_.indexOf(u.DIRECTORY.directory,g)}else if(c&&_.isObject(c)){var h=_.findWhere(u.DIRECTORY.directory,{id:c.id});f=_.indexOf(u.DIRECTORY.directory,h)}d().then(function(){idb.add(v,a,function(c){a.id=c,u[c]=a,u.DIRECTORY.directory[f].items.push(c),q(function(){b(a),eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_ADDED",data:a},null),e(a)})},!0)})}else e(!1)}function j(a,b){b=_.verifyCallback(b),a?d().then(function(){idb.update(v,_.pick(a,"id","title","url","color","icon","iconSize","userIcon"),function(){u[a.id]=a,eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_UPDATED",data:a},null),b(a)},!0)}):b(!1)}function k(a,b){if(b=_.verifyCallback(b),a=_.clone(a)){var c=a;if(_.isObject(a)&&(c=a.id),u[c]&&_.isString(u[c].userIcon)){var e=u[c].userIcon.replace(/^.*[\\\/]/,"");S3.deleteFile("icons",e,null)}d().then(function(){idb.remove(v,c,function(){delete u[c],_.map(u.DIRECTORY.directory,function(a){return a.items=_.without(a.items,c),a}),q(function(){eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"ITEM_REMOVED",data:c},null),b()})},!0)})}else b(!1)}function l(a,b){b=_.verifyCallback(b),u.DIRECTORY.directory.push({id:getUUID(),name:a,items:[]}),d().then(function(){q(b)})}function m(a,b){if(b=_.verifyCallback(b),a=_.clone(a),!a||_.isUndefined(a.id))b(!1);else{var c=_.findWhere(u.DIRECTORY.directory,{id:a.id}),e=_.indexOf(u.DIRECTORY.directory,c);u.DIRECTORY.directory[e]=a,d().then(function(){q(b)})}}function n(a,b){b=_.verifyCallback(b),a=_.clone(a);var c=a;_.isObject(a)&&(c=a.id);var e=_.findWhere(u.DIRECTORY.directory,{id:c}),f=_.indexOf(u.DIRECTORY.directory,e),g=u.DIRECTORY.directory[f].items;u.DIRECTORY.directory=_.filter(u.DIRECTORY.directory,function(a){return a.id!=c}),_.size(g)>0?async.map(g,function(a,b){idb.remove(v,a,function(){delete u[a],b(null)},!0)},function(){d().then(function(){q(b)})}):d().then(function(){q(b)})}function o(a,b){b=_.verifyCallback(b);var c=urls.getHostName(a,!0);y[c]?(y[c].requestedUrl=a,b(y[c])):(y[c]={item:{url:a},requestedUrl:a,prettyUrl:c,palette:[],gallery:null},gallery.searchByDomain(c,function(a){a?(y[c].item.gallery_id=a.id,y[c].item.title=a.title,y[c].item.icon=a.assets.logo?a.assets.logo:null,y[c].item.color=a.assets.color,y[c].gallery=a,y[c].palette=a.assets.palette,y[c].palette.unshift(a.assets.color),b(y[c])):graphicAssets.webColorPicker(c,function(a){a&&a.r&&(y[c].item.color=a.c,y[c].palette=a.p,y[c].palette.unshift(a.c)),urls.getTitleByUrl(c,function(a){a&&(y[c].item.title=a),y[c].item.color&&"#ffffff"==y[c].item.color.toLowerCase()&&(y[c].item.color="#efefef"),b(y[c])})})}))}function p(){idb.getAll(v,function(a){if(a){var b=0;_.each(a.DIRECTORY.directory,function(c){c.items=_.filter(c.items,function(c){return _.isUndefined(a[c])?(b++,!1):!0}),c.id||(console.error("favorites :: found a category without an id",c),c.id=getUUID(),b++)}),b>0&&idb.update(v,a.DIRECTORY,function(){u=a,eventManager.dispatchEvent(v,"FAVORITES_EVENT",{type:"DIRECTORY_UPDATE",data:a.DIRECTORY.directory},null)},!0)}})}function q(a){a=_.verifyCallback(a),u.DIRECTORY={id:"DIRECTORY",ts:Date.now(),directory:u.DIRECTORY.directory},spotsAPI.getSequence(v,function(b){var c={type:"DIRECTORY_UPDATE",data:u.DIRECTORY.directory};0===b?idb.add(v,u.DIRECTORY,function(){eventManager.dispatchEvent(v,"FAVORITES_EVENT",c,null),a()},!0):idb.update(v,u.DIRECTORY,function(){eventManager.dispatchEvent(v,"FAVORITES_EVENT",c,null),a()},!0)},null)}function r(a){a=_.verifyCallback(a),e(function(b){var c=_.map(b.DIRECTORY.directory,function(a){return{name:a.name,id:a.id}});a(c)})}function s(a,b,c){var d=0,e=0;_.each(u.DIRECTORY.directory,function(c,f){-1!=c.items.indexOf(a)&&(d=f),b==c.id&&(e=f)}),u.DIRECTORY.directory[d].id!==b&&(u.DIRECTORY.directory[d].items=_.reject(u.DIRECTORY.directory[d].items,function(b){return b==a}),u.DIRECTORY.directory[e].items.push(a),q(c))}function t(a){var b=_.where(u.DIRECTORY.directory,{id:"recommended"});if(b.length&&b[0].items.length){var c=_.map(b[0].items,function(a){return u[a]});a(_.compact(c))}else a([])}config.module_import_list.push("favorites");var u,v=spotsManager.spotID("favorites"),w=!0,x=$.Deferred(),y={};return a(),eventManager.addEventListener(v,"UPDATE_EVENT",a),{addItem:i,editItem:j,removeItem:k,enrichItem:b,addCategory:l,editCategory:m,removeCategory:n,directorySave:q,getItem:f,getFavorites:e,search:h,getDetailsForUrl:o,getCategories:r,getRecommended:t,changeItemCategory:s}}(),window.recentlyClosed=function(){"use strict";function a(a,b){b=_.verifyCallback(b),tabs.getRecentlyClosed(function(c){b(_.first(c,a))})}return config.module_import_list.push("recentlyClosed"),{getItems:a}}(),window.topSites=function(){"use strict";function a(a,b){(!a||_.isFunction(a))&&(b=a,a=Number(config.topSitesItems)||20),b=_.verifyCallback(b),d().then(function(c){webScrapper.scrapeAll(_.pluck(c,"url")).progress(function(){var c=_.compact(arguments);b(_.first(c,a))})})}function b(a,b,c){c({query:a,spotID:spotsManager.spotID("favorites"),type:"top-sites",priority:600,results:b})}function c(c,d,e){e=_.verifyCallback(e),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"top-sites")?a(function(a){var f=window.search.buildSearchRegex(c),g=_.filter(a,function(a){return f.test(a.title)||f.test(a.url)});g=_.first(g,d),b(c,g,e)}):b(c,[],e)}config.module_import_list.push("topSites");var d=_.cacheFor(6e5,function(){return $.Deferred(function(a){chrome.topSites.get(a.resolve)}).promise()});return{getTopSites:a,search:c}}(),window.gallery=function(){function a(){idb.getAll(spotsManager.spotID("gallery"),function(a){!a||$.isEmptyObject(a)?$.ajax(config.gallery_local_data_path,{dataType:"text",type:"GET",success:function(a){e(a,function(){b(!0)})},error:function(a){console.error(a)}}):(_.each(a,function(a){i[a.id]=a.value}),b(!1))})}function b(a){h=_.clone(i.items),$.ajax(config.gallery_remote_data_path+config.cb,{dataType:"text",type:"GET",success:function(f){e(f,function(e){e?(j=config.gallery_min_updateFailTimeout,configAPI.set("gallery_last_update",(new Date).getTime()),a||c(h),setTimeout(b,config.gallery_autopull_interval)):d()})},error:d})}function c(a){var b=[];_.each(i.items,function(c,d){!a[d]&&c.assets&&c.assets.icon&&c.description&&b.push(d)}),b.length>0}function d(){j+=j,j>config.gallery_max_updateFailTimeout&&(j=config.gallery_max_updateFailTimeout),setTimeout(function(){b()},j)}function e(a,b){var c=null;try{var d=utilsAPI.decrypt(a);c=JSON.parse(d)}catch(e){console.error("Decrypt error:",e),b(!1)}if(c&&(!i.version||i.version<c.version))try{idb.clear(spotsManager.spotID("gallery")),i={};var f=[];_.each(c,function(a,b){i[b]=a,f.push({type:"put",value:{id:b,value:a}})}),idb.batch(spotsManager.spotID("gallery"),f,function(){b(!0)},function(){b(!1)})}catch(e){console.error("Handle data Error:",e),b(!1)}}function f(a,b){a=urls.getHostName(a,!0),g(function(){var c=_.find(i.items,function(b,c){return b.web.match.test||(b.web.match=new RegExp(b.web.match)),b.web.match.test(a)?(b.id=c,!0):!1});b(c)})}function g(a){i&&i.items?a(i):_.delay(function(){g(a)},100)}config.module_import_list.push("gallery");var h,i={},j=config.gallery_min_updateFailTimeout;return a(),{updateRepository:function(a){b(a)},gallery:function(){return i},discoveryItemsArray:function(){var a=[];return _.each(i.items,function(b,c){b.assets&&b.assets.icon&&b.description&&(b.id=c,a.push(b))}),a},searchByDomain:f,updateFavItemByDomain:function(a,b){f(a,function(a){a?(b.gallery_id=a.id,b.title=a.title,a.assets&&(b.color=a.assets.color?a.assets.color:"#ffffff",a.assets.logo&&(b.icon=a.assets.logo))):delete b.icon})},getFavItemColorPalette:function(a,b){f(a,function(a){b(a.assets.palette)})},getGallery:g}}(),window.call_log=function(){"use strict";function a(){idb.getAll(k,function(a){d(a),eventManager.dispatchEvent(k,"CACHE_UPDATE")}),b()}function b(){magicAPI.getLastUpdateTimestamp(k,function(a){magicAPI.getItems(l,function(b){c(a,b)})})}function c(a,b){var c=0;idb.search(k,function(b){return b.from&&b.timestamp>a},function(a){if(a.length>0){var d=[];_.each(a,function(a){var e=a.number,f=_.find(d,function(a){return magicAPI.getObjectKey(l,e)==a.id});f||(f=_.find(b,function(a){return magicAPI.getObjectKey(l,e)==a.id})),f?f.score++:f=magicAPI.createMagicItem(l,e,1),d.push(f),a.timestamp>c&&(c=a.timestamp)}),magicAPI.setItems(l,d),magicAPI.setLastUpdateTimestamp(k,parseInt(c,10))}})}function d(a){a=_.sortBy(a,function(a){return a.timestamp}),j=[];var b;_.each(a,function(a){b&&b.number==a.number||(b=a,b.calls=[],j.push(b)),b.calls.push({type:a.type,timestamp:a.timestamp})})}function e(a,b,c){if(j){var d=j.length;if(a){d=-1;for(var f=j.length-1;f>=0;f--)if(j[f].timestamp==a.timestamp){d=f;break}0>=d&&c([])}var g=d-b>0?d-b:0;c(j.slice(g,d))}else setTimeout(function(){e(a,b,c)},100)}function f(a){if(j&&a){for(var b,c=j.length-1;c>=0;c--)if(j[c].timestamp==a.timestamp){b=c+1;break}var d=[];if(b&&b<j.length){var e=j.length;d=j.slice(b,e)}return b>0&&a.calls.length<j[b-1].calls.length&&d.unshift(j[b-1]),d}return console.warn("Calls have not been loaded yet or an item has not been sent, returning an empty array."),[]}function g(a){idb.getAll(k,function(b){a(b)})}function h(a,b){idb.get(k,a,function(a){b(a)})}function i(a){notificationManager.getAll({spotID:k},function(b){b&&_.each(b,function(b){b.data&&b.data.number==a&&notificationManager.clear(b.id,null)})})}config.module_import_list.push("call_log");var j,k=spotsManager.spotID("call_log"),l=spotsManager.spotID("contacts");return a(),eventManager.addEventListener(k,"UPDATE_EVENT",function(){a()}),{getObject:h,getAllObjects:g,getAllObjectsArray:function(a){g(function(b){a(_.toArray(b))})},getPreviousCalls:e,getNewCalls:f,clearNotificationsForNumber:i}}(),window.contacts=function(){"use strict";function a(){idb.getAll(o,function(a){_.each(a,function(a){_.each(a.phones,function(b){p[b]=a})}),eventManager.dispatchEvent(o,"CACHE_UPDATE",null)})}function b(a){if(p[a])return p[a];var b=a.toString().replace(/\D/g,"");if(b=parseInt(b,10),b.length>=5){var c=_.keys(p),d=_.find(c,function(a){return-1!==a.indexOf(b)?!0:void 0});if(d){var e=p[d];return p[a]=e,e}}return null}function c(a){idb.getAll(o,function(b){a(b)})}function d(a){c(function(b){a(_.toArray(b))})}function e(a,b){idb.get(o,a,function(a){b(a)})}function f(a,b){var c=_.sortBy(a,function(a){if(a.notifications){var b=_.max(a.notifications,function(a){return a});return a.score=b,b}return"number"==typeof a.score?a.score:-1});b(c)}function g(a,b,c){magicAPI.getItems(o,function(d){_.each(a,function(a){var b=_.find(this,function(b){var c=_.find(a.phones,function(a){return b.objectID==a});return c});a.score=b?b.score:0},d),f(a,function(a){b&&(a=_.last(a,b));for(var d=0;d<a.length;d++)a[d].score=d;c(a)})})}function h(){n=null}function i(a,b){_.size(n)>=a?b(_.last(n,a)):magicAPI.getItems(o,function(c){f(c,function(c){n=_.last(c,a),b(n)})})}function j(a){return a.defaultNumber||_.find(a.phones,function(a,b){return"mobile"==b.toLowerCase()})||_.toArray(a.phones)[0]}function k(a,b,c){c({query:a,spotID:spotsManager.spotID("contacts"),type:"contacts",priority:1e3,results:b})}function l(a,b,c){if(c=_.verifyCallback(c),!config.limitSearchResultType||_.contains(config.limitSearchResultType,"contacts")){var d=window.search.buildSearchRegex(a);idb.search(o,function(a){return d.test(a.givenName)||d.test(a.familyName)||d.test(a.display)},function(d){g(d,q,function(d){d=_.first(d,b),k(a,d,c)})})}else k(a,[],c)}function m(a){return phoneformat.formatLocal(geolocation.getCountryCode(),a)}config.module_import_list.push("contacts");var n,o=spotsManager.spotID("contacts"),p={},q=3;return eventManager.addEventListener(o,"UPDATE_EVENT",a),eventManager.addEventListener("MAGIC","ITEM_UPDATED",h),a(),{getObject:e,getAllObjects:c,getAllObjectsArray:d,getContactByPhoneNumber:b,getTopMagicResults:i,getContactDefaultPhone:j,search:l,normalizePhoneNumber:_.memoize(m)}}(),function(){function a(a){a.spotID==c&&a.data&&magicAPI.clearNotification(contactsSpotID,a.data.number,a.id)}window.contactsSpotID=spotsManager.spotID("contacts");var b=spotsManager.spotID("call_log"),c=spotsManager.spotID("sms"),d="Missed Call";eventManager.addEventListener("NOTIFICATIONS","NOTIFICATION_CLEARED",a),eventManager.addEventListener(b,1,function(a){(new Date).getTime()-a.timestamp>12e4||(a.contact=contacts.getContactByPhoneNumber(a.number),a.contact||(a.contact={}),a.contact.display||(a.contact.display=languageManager.getTranslation("unknown")),a.contact.toastImage=a.contact.image?a.contact.image:"/img/default-image-grey.png",notificationManager.set({spotID:b,objectID:a.timestamp,expiration:(new Date).getTime()+3e4,priority:5,newtab:!1,opentab:!1,toast:{type:"basic",title:a.contact.display,message:languageManager.getTranslation("incoming_call"),contextMessage:a.number,iconUrl:a.contact.toastImage,eventTime:parseInt(a.timestamp,10)}},null),_gaq.push(["_trackEvent","Phone","Call-Notifications","Incoming Call"]))}),eventManager.addEventListener(b,2,function(a){notificationManager.clear(b+"_"+a.timestamp),_gaq.push(["_trackEvent","Phone","Call-Notifications","Answered Call"])}),eventManager.addEventListener(b,3,function(a){notificationManager.clear(b+"_"+a.timestamp),_gaq.push(["_trackEvent","Phone","Call-Notifications",d])}),eventManager.addEventListener(b,4,function(){_gaq.push(["_trackEvent","Phone","Call-Notifications","Outgoing Call"])}),eventManager.addEventListener(b,"UPDATE_EVENT",function(a){var c=_.findWhere(a,{spot_id:b}).sequences;_.each(c,function(c){var d=_.where(c.sequence_data,{type:"add"});_.each(d,function(c){a=c.object_data,a.contact=contacts.getContactByPhoneNumber(a.number),a.contact||(a.contact={}),a.contact.display||(a.contact.display=languageManager.getTranslation("unknown")),a.contact.toastImage=a.contact.image?a.contact.image:"/img/default-image-grey.png","3"==a.type?(notificationManager.set({spotID:b,type:"Missed-Call",objectID:a.id,expiration:parseInt(a.timestamp,10)+288e5,priority:5,newtab:!0,opentab:!0,toast:{type:"basic",title:a.contact.display,contextMessage:a.number,message:languageManager.getTranslation("missed_call"),iconUrl:a.contact.toastImage}},function(){}),_gaq.push(["_trackEvent","Phone","Call","Missed"])):call_log.clearNotificationsForNumber(a.number)})})}),eventManager.addEventListener(c,"UPDATE_EVENT",function(a){var b=_.findWhere(a,{spot_id:c}).sequences;_.each(b,function(a){var b=_.where(a.sequence_data,{type:"add"});_.each(b,function(a){var b=a.object_data;"1"==b.type?(b.contact=contacts.getContactByPhoneNumber(b.number),b.contact||(b.contact={}),b.contact.display||(b.contact.display=languageManager.getTranslation("unknown")),b.contact.toastImage=b.contact.image?b.contact.image:"/img/default-image-grey.png",notificationManager.set({spotID:c,objectID:b.id,expiration:parseInt(b.timestamp,10)+864e5,priority:4,newtab:!1,opentab:!0,toast:{type:"basic",title:b.contact.display,contextMessage:b.number,message:b.text,iconUrl:b.contact.image}},function(a){magicAPI.handleNotification(contactsSpotID,b.number,a)}),_gaq.push(["_trackEvent","Phone","SMS-Received","Incoming sms"])):(_gaq.push(["_trackEvent","Phone","SMS-Received","Outgoing sms"]),a.clearNotificationsForNumber(b.number))})})})}(),window.sms=function(){"use strict";function a(){g(),b()}function b(){magicAPI.getLastUpdateTimestamp(p,function(a){magicAPI.getItems(q,function(b){c(a,b)})})}function c(a,b){var c=0;idb.search(p,function(b){return b.from&&b.timestamp>a},function(a){if(a.length>0){var d=[];_.each(a,function(a){var e=a.number,f=_.find(d,function(a){return magicAPI.getObjectKey(q,e)==a.id});f||(f=_.find(b,function(a){return magicAPI.getObjectKey(q,e)==a.id})),f?f.score++:f=magicAPI.createMagicItem(q,e,1),d.push(f),a.timestamp>c&&(c=a.timestamp)}),magicAPI.setItems(q,d),magicAPI.setLastUpdateTimestamp(p,parseInt(c,10))}})}function d(a){var b=_.filter(a,function(a){return a.spot_id==p&&(a.snapshot||a.sequences.length>0)});b.length>0&&g(function(){e(a)})}function e(a){var b=[];_.each(a,function(a){_.each(a.sequences,function(a){_.each(a.sequence_data,function(a){if(a.type="add"){var c=a.object_data;b.push(c);var d=c.number;magicAPI.incrementItemScore(q,d),magicAPI.setLastUpdateTimestamp(p,c.timestamp)}})})}),eventManager.dispatchEvent(p,"SMS_EVENT",b)}function f(a){notificationManager.getAll({spotID:p},function(b){b&&_.each(b,function(b){b.data.number==a&&notificationManager.clear(b.id,null)})})}function g(a){a=_.verifyCallback(a),idb.getAll(p,function(b){var c={};_.each(b,function(a){c[a.number]?c[a.number].timestamp<a.timestamp&&(c[a.number]=a):c[a.number]=a}),o=[],_.each(c,function(a){o.push(a)}),o=_.sortBy(o,function(a){return a.timestamp}),a()})}function h(a,b,c){if(c=_.verifyCallback(c),o){var d=_.sortBy(o,function(a){return-1*a.timestamp});if(d[a]){var e=a,f=a+b+1>d.length?d.length:a+b;c(d.slice(e,f))}else c([])}else setTimeout(function(){h(lastThreadFetched,threadFetchCount,c)},100)}function i(a){return a=_.verifyCallback(a),a(o),o}function j(a,b){b=b?b:_.noop,idb.search(p,function(b){return b.number==a.number||b.from&&a.from&&b.from==a.from},b)}function k(a,b){b=b?b:_.noop,idb.search(p,function(b){return b.number==a},function(a){b(a)})}function l(a){idb.getAll(p,function(b){a(b)})}function m(a){l(function(b){a(_.toArray(b))})}function n(a,b){idb.get(p,a,function(a){b(a)})}config.module_import_list.push("sms");var o,p=spotsManager.spotID("sms"),q=spotsManager.spotID("contacts");return a(),eventManager.addEventListener(p,"UPDATE_EVENT",d),{getObject:n,getAllObjects:l,getAllObjectsArray:m,getPreviousThreads:h,getAllThreads:i,getThread:j,getThreadForNumber:k,initMagic:b,clearNotificationsForNumber:f}}(),window.search=function(){"use strict";function a(a,d){d=_.verifyCallback(d),b[a]?_.each(b[a],function(a){d(a)}):a&&(b[a]={},_.each(c,function(c){window[c.service]&&window[c.service].search&&window[c.service].search(a,c.limit,function(c){c&&(b[a][c.spotID+"_"+c.type]=c,d(c))})}))}config.module_import_list.push("search"),eventManager.addEventListener(spotsManager.spotID("search"),1,function(a){tabs.openLinkInNewTab(a.link)});var b={},c=[{service:"webSearch",limit:4},{service:"favorites",limit:3},{service:"topSites",limit:3},{service:"bookmarks",limit:3},{service:"chromeApps",limit:3},{service:"contacts",limit:3}],d=_.memoize(function(a){var b=new RegExp.Safe(a,"i").source;return a.length<3&&(b="^"+b),b=b.replace(/\s+/g,"\\s+"),new RegExp(b,"i")});return{search:a,buildSearchRegex:d}}(),window.webSearch=function(){function a(a,c,d){if(d=_.verifyCallback(d),a.length>0){var e={label:a,score:1e4,value:config.searchProviderUrl+a,type:"web-default"},f={query:a,spotID:spotsManager.spotID("search"),type:"web-search",priority:100,results:[e]};b(a,c,function(a,b){a||(f.results=b.concat(f.results)),d(f)})}else d(null)}function b(a,b,g){f[a]?g(null,f[a]):(c(),d=$.ajax({url:e,dataType:"json",data:{client:"chrome-omni",ie:"utf-8",oe:"utf-8",hl:"en-US",q:a},success:function(c){var d=[];if(c[1].length>0){var e=c[1].reverse(),h=c[2].reverse(),i=c[4]["google:suggesttype"].reverse(),j=c[4]["google:suggestrelevance"].reverse();_.each(i,function(a,b){var c={label:e[b],score:j[b],value:config.searchProviderUrl+e[b],type:"web"};"NAVIGATION"==a?(c.type="navigation",c.value=e[b],h[b]&&(c.label=h[b])):"CALCULATOR"==a&&(c.type="calculator"),d.push(c)}),d=_.last(d,b),f[a]=d}g(null,d)},error:function(a,b,c){g(c,[])}}))}function c(){d&&(d.abort(),d=null)}var d,e="http://google.com/complete/search",f={};return{search:a}}(),window.weather=function(){function a(a,b){return $.Deferred(function(c){var d=$.ajax({url:f,data:{lat:a,lon:b,units:"metric",lang:h[languageManager.getLang()]||"en"}});d.then(function(a){c[a.main?"resolve":"reject"](a)},c.reject)})}function b(){return config.weatherLocation?a(config.weatherLocation.lat,config.weatherLocation.lon):a(config.geolocation.lat,config.geolocation.lon)}function c(){i=_.cacheFor(g,b)}function d(a){return a?a(g):g}function e(a){a?configAPI.set("weatherLocation",a):configAPI.remove("weatherLocation"),c()}var f=config.weatherAPI,g=6e5,h={en:"en",ru:"ru",it:"it",es:"sp",uk:"ua",de:"de",pt:"pt",ro:"ro",pl:"pl",fi:"fi",nl:"nl",fr:"fr",bg:"bg",sv:"se",zh:"zh_cn",tr:"tr",cs:"cz",gl:"gl",vi:"vi",ar:"ar",mk:"mk",sk:"sk"},i=function(){};return config.backgroundInitialized.done(function(){c(),eventManager.addEventListener("SETTINGS","LANGUAGE_CHANGED",c),geolocation.geolocate().then(function(){var a=/US|PR|JM|BS|GU|BZ|VI|KY|PW/.test(geolocation.getCountryCode());config.temperatureUnit||(config.temperatureUnit=a?"fahrenheit":"celsius")})}),{setLocation:e,getRefreshInterval:d,getWeatherByLatLon:a,getWeather:function(a){return geolocation.geolocate().then(function(){return i().then(a)})}}}(),refreshExtension()},refreshExtension=function(){chromeEvents.refreshExtension(),config.backgroundInitialized.resolve(),time.end("backgroundInitialized"),_gaq.push(["_trackEvent","Background","Init-Complete"])};init();
